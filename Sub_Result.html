<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết Quả</title>
    <style>
        /* ==================== GLOBAL STYLES ==================== */
        body {
            background-color: white; 
            font-family: Arial, sans-serif;
            color: black;
            margin: 0;
            padding: 20px;
            overflow: auto;
            font-weight: bold; 
        }
        
        /* Đảm bảo tất cả các tiêu đề và container con cũng là bold */
        h2, h3, span, p {
            font-weight: bold !important;
            font-style: normal !important;
            color: black !important;
        }

        /* Container thay thế cho khu vực nhập liệu */
        #headerContainer {
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            text-align: center;
        }
        
        #resultsContainer {
            border: 1px solid #ccc;
            padding: 10px;
            background: #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
            min-height: 100px;
        }

        /* Đã xóa #messageBox style */
        
        /* Đảm bảo chữ đen và đậm cho các dòng kết quả */
        #resultsContainer p {
            color: black !important;
            font-weight: bold !important;
        }
    </style>
</head>
<body>

    <div id="headerContainer">
        <h2 style="margin: 0;">Kết quả</h2>
        <span id="roomStatus" style="color: blue;">Đang kết nối...</span>
    </div>
    
    <div id="resultsContainer">
        <p style="text-align:center; font-weight: bold; font-size: 1em; color: black;">Đang chờ Mã phòng từ URL...</p>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const SOCKET_SERVER_URL = "https://buzzgame1-1.onrender.com"; 
        const socket = io(SOCKET_SERVER_URL, { autoConnect: true });
        
        const resultsContainer = document.getElementById('resultsContainer');
        const roomStatus = document.getElementById('roomStatus');
        
        let currentRoom = null; 
        let initialRoomCode = null;
        
        let currentSortOption = 'time'; 
        let allContestants = []; 

        // Đã xóa hàm showMessage()
        
        function getRoomCodeFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const roomid = params.get('roomid');
            if (roomid && roomid.length === 6 && !isNaN(roomid)) {
                return parseInt(roomid);
            }
            return null;
        }

        // CẬP NHẬT: Hàm renderResults để sắp xếp dữ liệu trước khi hiển thị (đồng bộ với Host)
        function renderResults(data) {
            resultsContainer.innerHTML = ''; 

            if (data.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align:center; font-size: 1em; color: black;">Chưa có đáp án nào được gửi.</p>';
                return;
            }

            // BƯỚC 1: Sao chép và sắp xếp dữ liệu dựa trên cấu hình hiện tại (đồng bộ với Host)
            const sortedData = [...data];
            
            if (currentSortOption === "time") {
                sortedData.sort((a, b) => a.time - b.time); 
            } else if (currentSortOption === "join") { 
                sortedData.sort((a, b) => {
                    let idxA = allContestants.indexOf(a.name);
                    let idxB = allContestants.indexOf(b.name);
                    
                    if (idxA === -1) idxA = 9999;
                    if (idxB === -1) idxB = 9999;
                    
                    return idxA - idxB;
                });
            }

            // BƯỚC 2: Hiển thị dữ liệu đã sắp xếp
            sortedData.forEach(item => {
                const totalSeconds = Math.floor(item.time);
                // Lấy 2 chữ số thập phân (đảm bảo hiển thị giống Host)
                const hundredths = Math.floor((item.time % 1) * 100); 
                const formattedTime = `${totalSeconds.toString()}.${hundredths.toString().padStart(2, '0')}`;
                
                const resultText = `${item.name} | ${item.answer} | ${formattedTime}`;
                
                const p = document.createElement('p');
                p.textContent = resultText; 
                p.style.fontSize = '1.2em';
                p.style.borderBottom = '1px dashed #eee'; 
                p.style.padding = '8px 0';
                p.style.margin = '0';
                p.style.textAlign = 'left';
                
                resultsContainer.appendChild(p);
            });
        }
        
        // ========================= SOCKET.IO LOGIC =========================

        function joinRoom(roomCode, isRejoin = false) {
            if (!roomCode) {
                 roomStatus.textContent = "LỖI: URL thiếu Mã phòng (roomid=).";
                 resultsContainer.innerHTML = '<p style="text-align:center; font-size: 1em; color: red;">Vui lòng truy cập theo định dạng: **Result.html?roomid=MÃ_PHÒNG**</p>';
                 return;
            }
            
            roomStatus.textContent = `Đang tham gia Phòng: ${roomCode}...`;

            if (isRejoin) {
                socket.emit("viewer-rejoin-room", roomCode);
            } else {
                socket.emit("viewer-join-room", roomCode);
            }
        }
        
        socket.on("connect", () => {
             console.log("Connected to server. ID:", socket.id);
             if (currentRoom) {
                 joinRoom(currentRoom, true);
             } else if (initialRoomCode) {
                 joinRoom(initialRoomCode);
             }
        });

        // Event thành công khi tham gia/rejoin phòng
        socket.on("viewer-join-success", (data) => {
            currentRoom = data.roomCode;
            roomStatus.textContent = `Đang xem kết quả Phòng: ${currentRoom}`;
            
            currentSortOption = data.sortOption || 'time';
            allContestants = data.allContestants || [];
            
            renderResults(data.answers);
            // Đã xóa dòng showMessage
        });

        // Lắng nghe lỗi khi tham gia
        socket.on("join-error", (message) => {
             roomStatus.textContent = `Lỗi tham gia phòng: ${initialRoomCode}`;
             // Đã xóa dòng showMessage
             resultsContainer.innerHTML = `<p style="text-align:center; font-size: 1em; color: red;">${message}</p>`;
        });
        
        // Lắng nghe cập nhật kết quả (từ server)
        socket.on("update-results", (data) => {
             currentSortOption = data.sortOption || currentSortOption;
             allContestants = data.allContestants || allContestants;
             
             renderResults(data.answers);
             console.log("Results updated from server.");
        });
        
        // BỔ SUNG: Lắng nghe sự kiện Host thay đổi thứ tự sắp xếp
        socket.on("update-sort-config", (data) => {
            if (data.sortOption) {
                currentSortOption = data.sortOption;
            }
            if (data.allContestants) {
                allContestants = data.allContestants;
            }
            
            if (currentRoom) {
                socket.emit("viewer-request-update", currentRoom);
            }
        });

        // Sự kiện khi đáp án bị reset
        socket.on("answers-reset", () => {
            // Đã xóa dòng showMessage
        });

        // Khởi tạo: Đọc mã phòng từ URL và tự động tham gia
        window.onload = () => {
             initialRoomCode = getRoomCodeFromUrl();
             if (socket.connected) {
                 joinRoom(initialRoomCode);
             } 
        };
    </script>
</body>
</html>