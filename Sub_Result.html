<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết Quả</title>
    <style>
        /* ==================== GLOBAL STYLES ==================== */
        body {
            background-color: white;
            font-family: Arial, sans-serif;
            color: black;
            margin: 0;
            padding: 20px;
            overflow: auto;
            font-weight: bold;
        }

        h2, h3, span, p {
            font-weight: bold !important;
            font-style: normal !important;
        }

        #headerContainer {
            margin-bottom: 20px;
            padding: 10px;
            background: yellow;
            color: green;
            border-radius: 5px;
            text-align: center;
        }

        #resultsContainer {
            border: 1px solid #ccc;
            padding: 10px;
            background: #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
            min-height: 100px;
        }

        #resultsContainer p {
            color: black !important;
            font-weight: bold !important;
        }

        /* ====== RADIO STYLE ====== */
        .option-group {
            margin: 8px 0;
            font-weight: bold;
            text-align: center;
        }

        .sort-option { color: purple; font-weight: bold; }
        .time-option { color: red; font-weight: bold; }

        .option-group input[type="radio"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #ff00cc;
            margin-right: 6px;
            vertical-align: middle;
            cursor: pointer;
            position: relative;
        }

        .option-group input[type="radio"]:checked {
            border: 2px solid orange;
        }

        .option-group input[type="radio"]:checked::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 8px;
            height: 8px;
            background: blue;
            border-radius: 50%;
        }
    </style>
</head>

<body>

    <div id="headerContainer">
        <h2 style="margin: 0;">Kết quả</h2>
        <span id="roomStatus" style="color: blue;">Đang kết nối...</span>
    </div>

    <div class="option-group sort-option">
        <label>
            <input type="radio" name="sort" value="join" onclick="setSortOption('join')">
            Theo thứ tự vào phòng
        </label>

        <label style="margin-left:20px;">
            <input type="radio" name="sort" value="time" checked onclick="setSortOption('time')">
            Theo thời gian trả lời
        </label>
    </div>

    <div class="option-group time-option">
        <label>
            <input type="radio" name="timeDisplay" value="show" checked onclick="toggleTimeDisplay(true)">
            Hiện thời gian
        </label>

        <label style="margin-left:20px;">
            <input type="radio" name="timeDisplay" value="hide" onclick="toggleTimeDisplay(false)">
            Ẩn thời gian
        </label>
    </div>
    
    <div id="resultsContainer">
        <p style="text-align:center; font-weight: bold; font-size: 1em; color: blue;">Đang chờ Mã phòng từ URL...</p>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const SOCKET_SERVER_URL = "https://buzzgame1-1.onrender.com";
        const socket = io(SOCKET_SERVER_URL, { autoConnect: true });

        const resultsContainer = document.getElementById('resultsContainer');
        const roomStatus = document.getElementById('roomStatus');

        let currentRoom = null;
        let initialRoomCode = null;

        // Các biến trạng thái hiển thị
        let currentSortOption = 'time';     // 'time' hoặc 'join'
        let isTimeVisible = true;           // true: hiện, false: ẩn
        
        // Dữ liệu
        let allContestants = [];            // Danh sách thí sinh vào phòng (để sort)
        let lastAnswersData = [];           // Lưu mảng kết quả gần nhất để render lại khi đổi option

        function getRoomCodeFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const roomid = params.get('roomid');
            if (roomid && roomid.length === 6 && !isNaN(roomid)) {
                return parseInt(roomid);
            }
            return null;
        }

        // ================= XỬ LÝ UI: OPTION BUTTONS =================

        // 1. Hàm xử lý khi bấm Radio Sắp xếp
        function setSortOption(option) {
            currentSortOption = option;
            // Render lại dữ liệu cũ với chế độ sắp xếp mới
            if (lastAnswersData.length > 0) {
                renderResults(lastAnswersData);
            }
        }

        // 2. Hàm xử lý khi bấm Radio Ẩn/Hiện thời gian (Đã bổ sung)
        function toggleTimeDisplay(show) {
            isTimeVisible = show;
            // Render lại dữ liệu cũ với chế độ hiển thị mới
            if (lastAnswersData.length > 0) {
                renderResults(lastAnswersData);
            }
        }

        // ================= HÀM RENDER CHÍNH =================

        function renderResults(data) {
            // Lưu lại dữ liệu để dùng khi user đổi option mà không cần server gửi lại
            lastAnswersData = data; 
            
            resultsContainer.innerHTML = '';

            if (!data || data.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align:center; font-size: 1em; color: black;">Chưa có đáp án nào được gửi.</p>';
                return;
            }

            // BƯỚC 1: Sao chép mảng để không ảnh hưởng dữ liệu gốc
            const sortedData = [...data];

            // BƯỚC 2: Sắp xếp
            if (currentSortOption === "time") {
                // Sắp xếp theo thời gian trả lời (nhanh nhất lên đầu)
                sortedData.sort((a, b) => a.time - b.time);
            } else if (currentSortOption === "join") {
                // Sắp xếp theo danh sách vào phòng (lấy từ Host)
                sortedData.sort((a, b) => {
                    let idxA = allContestants.indexOf(a.name);
                    let idxB = allContestants.indexOf(b.name);

                    // Nếu tên không có trong danh sách gốc, đẩy xuống cuối
                    if (idxA === -1) idxA = 9999;
                    if (idxB === -1) idxB = 9999;

                    return idxA - idxB;
                });
            }

            // BƯỚC 3: Hiển thị
            sortedData.forEach(item => {
                let resultText = "";

                if (isTimeVisible) {
                    // Nếu chế độ Hiện thời gian
                    const totalSeconds = Math.floor(item.time);
                    const hundredths = Math.floor((item.time % 1) * 100);
                    const formattedTime = `${totalSeconds.toString()}.${hundredths.toString().padStart(2, '0')}`;
                    resultText = `${item.name} | ${item.answer} | ${formattedTime}`;
                } else {
                    // Nếu chế độ Ẩn thời gian: Chỉ hiện Tên và Đáp án
                    resultText = `${item.name} | ${item.answer}`;
                }

                const p = document.createElement('p');
                p.textContent = resultText;
                p.style.fontSize = '1.2em';
                p.style.borderBottom = '1px dashed #eee';
                p.style.padding = '8px 0';
                p.style.margin = '0';
                p.style.textAlign = 'left';

                resultsContainer.appendChild(p);
            });
        }

        // ========================= SOCKET.IO LOGIC =========================

        function joinRoom(roomCode, isRejoin = false) {
            if (!roomCode) {
                roomStatus.textContent = "LỖI: URL thiếu Mã phòng (roomid=).";
                resultsContainer.innerHTML = '<p style="text-align:center; font-size: 1em; color: red;">Vui lòng truy cập theo định dạng: **Result.html?roomid=MÃ_PHÒNG**</p>';
                return;
            }

            roomStatus.textContent = `Đang tham gia Phòng: ${roomCode}...`;

            if (isRejoin) {
                socket.emit("viewer-rejoin-room", roomCode);
            } else {
                socket.emit("viewer-join-room", roomCode);
            }
        }

        socket.on("connect", () => {
            console.log("Connected to server. ID:", socket.id);
            if (currentRoom) {
                joinRoom(currentRoom, true);
            } else if (initialRoomCode) {
                joinRoom(initialRoomCode);
            }
        });

        // Event thành công khi tham gia/rejoin phòng
        socket.on("viewer-join-success", (data) => {
            currentRoom = data.roomCode;
            roomStatus.textContent = `Đang xem kết quả Phòng: ${currentRoom}`;
            roomStatus.style.color = "blue";

            // Cập nhật cấu hình từ server (nếu muốn đồng bộ ban đầu)
            // Tuy nhiên ưu tiên thao tác tại local của Viewer hơn
            if (data.allContestants) {
                allContestants = data.allContestants;
            }

            renderResults(data.answers);
        });

        // Lắng nghe lỗi khi tham gia
        socket.on("join-error", (message) => {
            roomStatus.textContent = `Lỗi tham gia phòng: ${initialRoomCode}`;
            resultsContainer.innerHTML = `<p style="text-align:center; font-size: 1em; color: red;">${message}</p>`;
        });

        // Lắng nghe cập nhật kết quả (từ server)
        socket.on("update-results", (data) => {
            // Khi có kết quả mới, cập nhật danh sách thí sinh luôn để đảm bảo sort đúng
            if (data.allContestants) {
                allContestants = data.allContestants;
            }
            renderResults(data.answers);
        });

        // Lắng nghe sự kiện Host thay đổi thứ tự hoặc danh sách thí sinh
        socket.on("update-sort-config", (data) => {
            // Chủ yếu lấy danh sách thí sinh (allContestants) để sort cho đúng
            if (data.allContestants) {
                allContestants = data.allContestants;
            }
            
            // Nếu muốn Viewer tự động đổi kiểu sort theo Host thì bỏ comment dòng dưới:
            // if (data.sortOption) { currentSortOption = data.sortOption; }

            // Render lại với dữ liệu hiện có
            if (currentRoom) {
                // Cách tốt nhất là render lại lastAnswersData với allContestants mới
                renderResults(lastAnswersData);
            }
        });

        // Sự kiện khi đáp án bị reset
        socket.on("answers-reset", () => {
            lastAnswersData = [];
            renderResults([]);
        });

        // Khởi tạo: Đọc mã phòng từ URL và tự động tham gia
        window.onload = () => {
            initialRoomCode = getRoomCodeFromUrl();
            if (socket.connected) {
                joinRoom(initialRoomCode);
            }
        };

    </script>
</body>

</html>