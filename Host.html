<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Host Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      text-align: center;
      padding: 20px;
    }

    input,
    button,
    textarea {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      font-weight: bold;
    }

    table,
    th,
    td {
      border: 1px solid #aaa;
      border-collapse: collapse;
      padding: 8px;
      margin: 10px auto;
    }

    table {
      width: 90%;
      background: #fff;
    }

    th {
      background: #f0f0f0;
    }

    /* In ƒë·∫≠m c√°c √¥ gi√° tr·ªã trong b·∫£ng ƒë√°p √°n */
    #tblAnswers td {
      font-weight: bold;
    }

    ol {
      text-align: center;
      width: 550px;
      margin: 10px auto;
      background: #fff;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 6px;
      font-weight: bold;
      word-wrap: break-word;
      overflow-wrap: break-word;
      list-style-position: inside;
    }

    #roomInfo {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      transition: all 0.25s ease;
    }

    #btnCreate {
      background: purple;
      color: white;
    }

    #unlockAnswersLimited,
    #unlockBuzzLimited {
      background: purple;
      color: white;
      font-weight: bold;
    }

    #unlockAnswersPermanent,
    #unlockBuzzPermanent {
      background: blue;
      color: white;
      font-weight: bold;
    }

    #lockAnswers,
    #lockBuzz {
      background: green;
      color: white;
      font-weight: bold;
    }

    #resetAnswers,
    #resetBuzz {
      background: yellow;
      color: black;
      font-weight: bold;
    }

    button:hover {
      background: #ff00cc !important;
      color: white !important;
    }

    .status-box {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 6px;
      margin: 5px;
      min-width: 160px;
      font-weight: bold;
      font-size: 17px;
    }

    .open {
      background: green;
      color: white;
      box-shadow: 0 0 10px green;
    }

    .locked {
      background: red;
      color: white;
    }

    #popupMessage {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: blue;
      color: white;
      padding: 15px 30px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s, top 0.5s;
      font-weight: bold;
    }

    .error {
      background-color: red;
      color: white;
      font-weight: bold;
    }

    .control-group {
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .control-item {
      display: flex;
      align-items: center;
    }

    .control-item label {
      font-weight: bold;
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <h1>Host Panel</h1>

  <div id="roomInfo"></div>
  <button id="btnCreate">T·∫°o ph√≤ng</button><br><br>

  <div>
    <div class="status-box locked" id="statusAnswer">ƒê√°p √°n: üîí ƒêang kh√≥a</div>
    <div class="status-box locked" id="statusBuzz">Chu√¥ng: üö´ ƒêang kh√≥a</div>
  </div><br>

  <div class="control-group">
    <div class="control-item">
      <label for="answerDuration">Th·ªùi gian m·ªü ƒë√°p √°n (gi√¢y):</label>
      <input type="number" id="answerDuration" value="0" min="1" max="300" style="width: 80px; font-weight: bold;">
    </div>
    <div class="control-item">
      <label for="buzzDuration">Th·ªùi gian m·ªü chu√¥ng (gi√¢y):</label>
      <input type="number" id="buzzDuration" value="0" min="1" max="300" style="width: 80px; font-weight: bold;">
    </div>
  </div>

  <button id="unlockAnswersLimited">M·ªü ƒë√°p √°n (Gi·ªõi h·∫°n)</button>
  <button id="unlockAnswersPermanent">M·ªü ƒë√°p √°n (Vƒ©nh vi·ªÖn)</button>
  <button id="lockAnswers">Kh√≥a ƒë√°p √°n</button>
  <button id="resetAnswers">Reset ƒë√°p √°n</button>

  <br>

  <button id="unlockBuzzLimited">M·ªü chu√¥ng (Gi·ªõi h·∫°n)</button>
  <button id="unlockBuzzPermanent">M·ªü chu√¥ng (Vƒ©nh vi·ªÖn)</button>
  <button id="lockBuzz">Kh√≥a chu√¥ng</button>
  <button id="resetBuzz">Reset chu√¥ng</button>

  <h2>ƒê√°p √°n (l·∫ßn g·ª≠i g·∫ßn nh·∫•t):</h2>
  <table id="tblAnswers">
    <tr>
      <th>T√™n</th>
      <th>ƒê√°p √°n</th>
      <th>Th·ªùi gian</th>
    </tr>
  </table>

  <h2>Th·ª© t·ª± b·∫•m chu√¥ng:</h2>
  <ol id="buzzList"></ol>

  <div id="popupMessage"></div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <script>
    // === CONFIG: replace with your Render URL (include https://) ===
    const SOCKET_SERVER_URL = "https://buzzgame1-1.onrender.com";
    // ============================================================

    const socket = io(SOCKET_SERVER_URL, { autoConnect: true });

    // Local UI state
    let answers = []; // M·∫£ng m√¥ ph·ªèng d·ªØ li·ªáu ƒë√°p √°n
    let buzzOrder = []; // M·∫£ng m√¥ ph·ªèng d·ªØ li·ªáu b·∫•m chu√¥ng
    let lockedAnswer = true;
    let lockedBuzz = true;
    let answerTimeout = null;
    let buzzTimeout = null;

    // Bi·∫øn l∆∞u th·ªùi ƒëi·ªÉm Host m·ªü kh√≥a ƒë·ªÉ t√≠nh Elapsed Time
    let answerStartTime = 0;
    let buzzStartTime = 0;

    // √ötil: format th·ªùi gian
    function formatTime(timestamp, startTime) {
      if (typeof timestamp !== 'number' || isNaN(timestamp) || startTime === 0) return '‚àû';
      const elapsedTime = Math.max(0, timestamp - startTime);
      const totalSeconds = elapsedTime / 1000;
      return totalSeconds.toFixed(3) + 's';
    }

    function showPopup(message, type = 'success') {
      const popup = document.getElementById('popupMessage');
      popup.innerText = message;
      if (type === 'error') popup.classList.add('error');
      else popup.classList.remove('error');

      popup.style.transition = 'none';
      popup.style.opacity = '0';
      popup.style.top = '20px';
      void popup.offsetHeight;

      popup.style.transition = 'opacity 0.5s, top 0.5s';
      popup.style.opacity = '1';
      popup.style.top = '40px';
      setTimeout(() => {
        popup.style.opacity = '0';
        popup.style.top = '20px';
      }, 3000);
    }

    // Rendering functions
    function renderAnswers() {
      const tbl = document.getElementById('tblAnswers');
      tbl.innerHTML = '<tr><th>T√™n</th><th>ƒê√°p √°n</th><th>Th·ªùi gian</th></tr>';
      // S·∫Øp x·∫øp theo th·ªùi gian (c≈© -> m·ªõi)
      answers.sort((a, b) => a.ts - b.ts).forEach(x => {
        const tr = tbl.insertRow();
        tr.insertCell().innerText = x.name;
        tr.insertCell().innerText = x.answer;
        tr.insertCell().innerText = formatTime(x.ts, answerStartTime);
      });
    }

    function renderBuzzList() {
      const ol = document.getElementById('buzzList');
      ol.innerHTML = '';
      buzzOrder.forEach(x => {
        const li = document.createElement('li');
        li.innerText = x.name + ' (' + formatTime(x.ts, buzzStartTime) + ')';
        ol.appendChild(li);
      });
    }

    function updateStatusDisplay() {
      const statusAnswer = document.getElementById('statusAnswer');
      const statusBuzz = document.getElementById('statusBuzz');

      if (lockedAnswer) {
        statusAnswer.className = 'status-box locked';
        statusAnswer.innerText = 'ƒê√°p √°n: üîí ƒêang kh√≥a';
      } else {
        statusAnswer.className = 'status-box open';
        statusAnswer.innerText = 'ƒê√°p √°n: üîì ƒêang m·ªü';
      }

      if (lockedBuzz) {
        statusBuzz.className = 'status-box locked';
        statusBuzz.innerText = 'Chu√¥ng: üö´ ƒêang kh√≥a';
      } else {
        statusBuzz.className = 'status-box open';
        statusBuzz.innerText = 'Chu√¥ng: üîî ƒêang m·ªü';
      }
    }

    // Host logic (k·∫øt n·ªëi server)
    let currentRoom = null;

    document.getElementById('btnCreate').onclick = () => {
      // Emit a NUMBER, not a string
      const code = Math.floor(100000 + Math.random() * 900000);
      socket.emit('host-create-room', code);
    };

    socket.on('room-created', (code) => {
      currentRoom = code;
      document.getElementById('roomInfo').innerHTML = `üîë <b>M√£ ph√≤ng:</b> <span style="color:black;">${code}</span>`;
      showPopup("ƒê√£ t·∫°o ph√≤ng th√†nh c√¥ng!");
      lockAnswersLocal();
      lockBuzzLocal();
      answers = [];
      buzzOrder = [];
      renderAnswers();
      renderBuzzList();
    });

    // Nh·∫≠n ƒë√°p √°n m·ªõi t·ª´ server
    socket.on('host-new-answer', (data) => {
      // data: { name, answer, ts }
      const existingIndex = answers.findIndex(a => a.name === data.name);
      if (existingIndex > -1) {
        answers[existingIndex] = data;
      } else {
        answers.push(data);
      }
      renderAnswers();
    });

    // Nh·∫≠n buzzer m·ªõi
    socket.on('host-new-buzz', (data) => {
      buzzOrder.push(data);
      renderBuzzList();
    });

    // Khi c√≥ thay ƒë·ªïi tr·∫°ng th√°i do server broadcast
    socket.on('answer-status-changed', ({ state, duration, startTime }) => {
      if (state === 'open') {
        if (duration > 0) {
          unlockAnswersLocalLimited(duration, startTime);
        } else {
          unlockAnswersLocalPermanent(startTime);
        }
      } else {
        lockAnswersLocal();
      }
    });

    socket.on('buzz-status-changed', ({ state, duration, startTime }) => {
      if (state === 'open') {
        if (duration > 0) {
          unlockBuzzLocalLimited(duration, startTime);
        } else {
          unlockBuzzLocalPermanent(startTime);
        }
      } else {
        lockBuzzLocal();
      }
    });

    // ===== C√°c h√†m ƒëi·ªÅu khi·ªÉn ƒê√°p √°n (local + emit) =====
    function lockAnswersLocal() {
      if (answerTimeout) {
        clearTimeout(answerTimeout);
        answerTimeout = null;
      }
      lockedAnswer = true;
      answerStartTime = 0;
      updateStatusDisplay();
    }

    function unlockAnswersLocalLimited(durationSeconds, startTimeFromServer = null) {
      if (answerTimeout) {
        clearTimeout(answerTimeout);
        answerTimeout = null;
      }
      
      // Lu√¥n d√πng `durationSeconds` (th·ªùi gian CHU·∫®N t·ª´ server)
      const duration = durationSeconds;

      lockedAnswer = false;
      answerStartTime = startTimeFromServer || Date.now();
      updateStatusDisplay();
      showPopup(`ƒê√£ m·ªü ƒë√°p √°n trong ${duration} gi√¢y!`); // Popup "M·ªü"

      if (duration > 0) {
        const now = Date.now();
        const elapsedSinceStart = Math.max(0, (now - answerStartTime));
        const remaining = Math.max(0, duration * 1000 - elapsedSinceStart);

        answerTimeout = setTimeout(() => {
          showPopup("H·∫øt gi·ªù. ƒê√°p √°n ƒë√£ t·ª± ƒë·ªông kh√≥a."); // Popup "H·∫øt gi·ªù"
          lockAnswersLocal();
        }, remaining);
      }
    }

    function unlockAnswersLocalPermanent(startTimeFromServer = null) {
      if (answerTimeout) {
        clearTimeout(answerTimeout);
        answerTimeout = null;
      }
      lockedAnswer = false;
      answerStartTime = startTimeFromServer || Date.now();
      updateStatusDisplay();
      showPopup("ƒê√£ m·ªü ƒë√°p √°n (Vƒ©nh vi·ªÖn).");
    }

    // ===== ƒê√ÇY L√Ä N∆†I S·ª¨A L·ªñI 15+5 =====
    document.getElementById('unlockAnswersLimited').onclick = () => {
      if (!currentRoom) return showPopup('Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc.', 'error');
      
      // Ch·ªâ ƒë·ªçc t·ª´ √¥ `answerDuration`
      const duration = parseInt(document.getElementById('answerDuration').value) || 0;
      socket.emit('host-toggle-answer', { roomCode: currentRoom, state: 'open', duration });
    };

    document.getElementById('unlockAnswersPermanent').onclick = () => {
      if (!currentRoom) return showPopup('Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc.', 'error');
      socket.emit('host-toggle-answer', { roomCode: currentRoom, state: 'open', duration: 0 });
    };

    document.getElementById('lockAnswers').onclick = () => {
      if (!currentRoom) return showPopup('Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc.', 'error');
      socket.emit('host-toggle-answer', { roomCode: currentRoom, state: 'locked', duration: 0 });
    };

    document.getElementById('resetAnswers').onclick = () => {
      answers = [];
      renderAnswers();
      showPopup("ƒê√£ reset danh s√°ch ƒë√°p √°n.");
    };

    // ===== Chu√¥ng =====
    function lockBuzzLocal() {
      if (buzzTimeout) {
        clearTimeout(buzzTimeout);
        buzzTimeout = null;
      }
      lockedBuzz = true;
      buzzStartTime = 0;
      updateStatusDisplay();
    }

    function unlockBuzzLocalLimited(durationSeconds, startTimeFromServer = null) {
      if (buzzTimeout) {
        clearTimeout(buzzTimeout);
        buzzTimeout = null;
      }

      // Lu√¥n d√πng `durationSeconds` (th·ªùi gian CHU·∫®N t·ª´ server)
      const duration = durationSeconds;

      lockedBuzz = false;
      buzzStartTime = startTimeFromServer || Date.now();
      updateStatusDisplay();
      showPopup(`ƒê√£ m·ªü chu√¥ng trong ${duration} gi√¢y!`); // Popup "M·ªü"

      if (duration > 0) {
        const now = Date.now();
        const elapsedSinceStart = Math.max(0, (now - buzzStartTime));
        const remaining = Math.max(0, duration * 1000 - elapsedSinceStart);

        buzzTimeout = setTimeout(() => {
          showPopup("H·∫øt gi·ªù. Chu√¥ng ƒë√£ t·ª± ƒë·ªông kh√≥a."); // Popup "H·∫øt gi·ªù"
          lockBuzzLocal();
        }, remaining);
      }
    }

    function unlockBuzzLocalPermanent(startTimeFromServer = null) {
      if (buzzTimeout) {
        clearTimeout(buzzTimeout);
        buzzTimeout = null;
      }
      lockedBuzz = false;
      buzzStartTime = startTimeFromServer || Date.now();
      updateStatusDisplay();
      showPopup("ƒê√£ m·ªü chu√¥ng (Vƒ©nh vi·ªÖn)!");
    }

    // ===== ƒê√ÇY L√Ä N∆†I S·ª¨A L·ªñI 15+5 =====
    document.getElementById('unlockBuzzLimited').onclick = () => {
      if (!currentRoom) return showPopup('Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc.', 'error');
      
      // Ch·ªâ ƒë·ªçc t·ª´ √¥ `buzzDuration`
      const duration = parseInt(document.getElementById('buzzDuration').value) || 0;
      socket.emit('host-toggle-buzz', { roomCode: currentRoom, state: 'open', duration });
    };

    document.getElementById('unlockBuzzPermanent').onclick = () => {
      if (!currentRoom) return showPopup('Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc.', 'error');
      socket.emit('host-toggle-buzz', { roomCode: currentRoom, state: 'open', duration: 0 });
    };

    document.getElementById('lockBuzz').onclick = () => {
      if (!currentRoom) return showPopup('Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc.', 'error');
      socket.emit('host-toggle-buzz', { roomCode: currentRoom, state: 'locked', duration: 0 });
    };

    document.getElementById('resetBuzz').onclick = () => {
      buzzOrder = [];
      renderBuzzList();
      showPopup("ƒê√£ reset th·ª© t·ª± chu√¥ng.");
    };

    // Init
    updateStatusDisplay();
    renderAnswers();
    renderBuzzList();

    // Socket connection error handling
    socket.on('connect_error', (err) => {
      showPopup("Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server Socket.IO. Ki·ªÉm tra SOCKET_SERVER_URL.", "error");
      console.error("connect_error:", err);
    });

  </script>
</body>

</html>