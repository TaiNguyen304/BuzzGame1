<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Host Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      text-align: center;
      padding: 20px;
    }

    input,
    button,
    textarea {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      font-weight: bold;
    }

    table,
    th,
    td {
      border: 1px solid #aaa;
      border-collapse: collapse;
      padding: 8px;
      margin: 10px auto;
    }

    table {
      width: 90%;
      background: #fff;
    }

    th {
      background: #f0f0f0;
    }

    /* FIX: Cập nhật CSS cho danh sách bấm chuông */
    ol {
      text-align: center;
      width: 550px;
      margin: 10px auto;
      background: #fff;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 6px;
      font-weight: bold;
      word-wrap: break-word;
      overflow-wrap: break-word;
      list-style-position: inside;
    }

    #roomInfo {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      transition: all 0.25s ease;
    }

    #btnCreate {
      background: purple;
      color: white;
    }

    #unlockAnswersLimited,
    #unlockBuzzLimited {
      background: purple;
      color: white;
      font-weight: bold;
    }

    #unlockAnswersPermanent,
    #unlockBuzzPermanent {
      background: blue;
      color: white;
      font-weight: bold;
    }

    #lockAnswers,
    #lockBuzz {
      background: green;
      color: white;
      font-weight: bold;
    }

    #resetAnswers,
    #resetBuzz {
      background: yellow;
      color: black;
      font-weight: bold;
    }

    button:hover {
      background: #ff00cc !important;
      color: white !important;
    }

    .status-box {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 6px;
      margin: 5px;
      min-width: 160px;
      font-weight: bold;
      font-size: 17px;
    }

    .open {
      background: green;
      color: white;
      box-shadow: 0 0 10px green;
    }

    .locked {
      background: red;
      color: white;
    }

    #popupMessage {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: blue;
      color: white;
      padding: 15px 30px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s, top 0.5s;
      font-weight: bold;
    }

    .error {
      background-color: red;
      color: white;
      font-weight: bold;
    }

    .control-group {
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .control-item {
      display: flex;
      align-items: center;
    }

    .control-item label {
      font-weight: bold;
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <h1>Host Panel</h1>

  <div id="roomInfo"></div>
  <button id="btnCreate">Tạo phòng</button><br><br>

  <div>
    <div class="status-box locked" id="statusAnswer">Đáp án: Đang khóa</div>
    <div class="status-box locked" id="statusBuzz">Chuông: Đang khóa</div>
  </div><br>

  <div class="control-group">
    <div class="control-item">
      <label for="answerDuration">Thời gian mở đáp án (giây):</label>
      <input type="number" id="answerDuration" value="15" min="1" max="300" style="width: 80px; font-weight: bold;">
    </div>
    <div class="control-item">
      <label for="buzzDuration">Thời gian mở chuông (giây):</label>
      <input type="number" id="buzzDuration" value="5" min="1" max="300" style="width: 80px; font-weight: bold;">
    </div>
  </div>

  <button id="unlockAnswersLimited">Mở đáp án (Giới hạn)</button>
  <button id="unlockAnswersPermanent">Mở đáp án (Vĩnh viễn)</button>
  <button id="lockAnswers">Khóa đáp án</button>
  <button id="resetAnswers">Reset đáp án</button>

  <br>

  <button id="unlockBuzzLimited">Mở chuông (Giới hạn)</button>
  <button id="unlockBuzzPermanent">Mở chuông (Vĩnh viễn)</button>
  <button id="lockBuzz">Khóa chuông</button>
  <button id="resetBuzz">Reset chuông</button>

  <h2>Đáp án (lần gửi gần nhất):</h2>
  <table id="tblAnswers">
    <tr>
      <th>Tên</th>
      <th>Đáp án</th>
      <th>Thời gian</th>
    </tr>
  </table>

  <h2>Thứ tự bấm chuông:</h2>
  <ol id="buzzList"></ol>

  <div id="popupMessage"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

    // THAY BẰNG CONFIG CỦA BẠN (chỉ cần 1 lần)
    const firebaseConfig = {
      apiKey: "AIzaSyAKTVuijDV4QfHjDcnEau2w9MaRL9YduEQ",
      authDomain: "buzz-game-7c91c.firebaseapp.com",
      databaseURL: "https://buzz-game-7c91c-default-rtdb.firebaseio.com",
      projectId: "buzz-game-7c91c",
      storageBucket: "buzz-game-7c91c.appspot.com",
      messagingSenderId: "946217092381",
      appId: "1:946217092381:web:d81064145965fb151acdf4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let roomRef = null;
    let currentRoomCode = null;
    let answerTimeout = null;
    let buzzTimeout = null;
    let answerStartTime = 0;
    let buzzStartTime = 0;

    function showPopup(message, type = 'success') {
      const popup = document.getElementById('popupMessage');
      popup.innerText = message;
      popup.className = type === 'error' ? 'error' : '';
      popup.style.opacity = '1';
      popup.style.top = '40px';
      setTimeout(() => {
        popup.style.opacity = '0';
        popup.style.top = '20px';
      }, 3000);
    }

    function generateRoomCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    function formatTime(timestamp, startTime) {
      if (!startTime || !timestamp) return '';
      return ((timestamp - startTime) / 1000).toFixed(3) + 's';
    }

    // === Đáp án ===
    function lockAnswers() {
      if (!roomRef) return;
      clearTimeout(answerTimeout);
      answerTimeout = null;
      answerStartTime = 0;
      set(ref(roomRef, 'lockedAnswer'), true)
        .then(() => showPopup("Đã khóa đáp án."))
        .catch(e => showPopup("Lỗi: " + e.message, "error"));
    }

    function unlockAnswersLimited() {
      if (!roomRef) return showPopup("Tạo phòng trước!", "error");
      const duration = parseInt(document.getElementById('answerDuration').value);
      if (isNaN(duration) || duration <= 0) return showPopup("Thời gian không hợp lệ!", "error");

      set(ref(roomRef, 'answerDuration'), duration).then(() => {
        answerStartTime = Date.now();
        set(ref(roomRef, 'lockedAnswer'), false).then(() => {
          showPopup(`Đã mở đáp án trong ${duration} giây!`);
          clearTimeout(answerTimeout);
          answerTimeout = setTimeout(lockAnswers, duration * 1000);
        });
      }).catch(e => showPopup("Lỗi: " + e.message, "error"));
    }

    function unlockAnswersPermanent() {
      if (!roomRef) return showPopup("Tạo phòng trước!", "error");
      set(ref(roomRef, 'answerDuration'), null).then(() => {
        answerStartTime = Date.now();
        set(ref(roomRef, 'lockedAnswer'), false).then(() => {
          showPopup("Đã mở đáp án (Vĩnh viễn).");
        });
      }).catch(e => showPopup("Lỗi: " + e.message, "error"));
    }

    // === Chuông ===
    function lockBuzz() {
      if (!roomRef) return;
      clearTimeout(buzzTimeout);
      buzzTimeout = null;
      buzzStartTime = 0;
      set(ref(roomRef, 'lockedBuzz'), true)
        .then(() => showPopup("Đã khóa chuông."))
        .catch(e => showPopup("Lỗi: " + e.message, "error"));
    }

    function unlockBuzzLimited() {
      if (!roomRef) return showPopup("Tạo phòng trước!", "error");
      const duration = parseInt(document.getElementById('buzzDuration').value);
      if (isNaN(duration) || duration <= 0) return showPopup("Thời gian không hợp lệ!", "error");

      set(ref(roomRef, 'buzzDuration'), duration).then(() => {
        buzzStartTime = Date.now();
        set(ref(roomRef, 'lockedBuzz'), false).then(() => {
          showPopup(`Đã mở chuông trong ${duration} giây!`);
          clearTimeout(buzzTimeout);
          buzzTimeout = setTimeout(lockBuzz, duration * 1000);
        });
      }).catch(e => showPopup("Lỗi: " + e.message, "error"));
    }

    function unlockBuzzPermanent() {
      if (!roomRef) return showPopup("Tạo phòng trước!", "error");
      set(ref(roomRef, 'buzzDuration'), null).then(() => {
        buzzStartTime = Date.now();
        set(ref(roomRef, 'lockedBuzz'), false).then(() => {
          showPopup("Đã mở chuông (Vĩnh viễn)!");
        });
      }).catch(e => showPopup("Lỗi: " + e.message, "error"));
    }

    // === Tạo phòng ===
    document.getElementById('btnCreate').onclick = () => {
      if (currentRoomCode) return showPopup("Phòng đã tồn tại!", "error");

      const code = generateRoomCode();
      currentRoomCode = code;
      document.getElementById('roomInfo').innerHTML = `Mã phòng: <b style="color:red;">${code}</b>`;
      roomRef = ref(db, 'rooms/' + code);

      set(roomRef, {
        answers: {},
        buzzOrder: [],
        lockedAnswer: true,
        lockedBuzz: true,
        answerDuration: null,
        buzzDuration: null
      }).then(() => {
        document.getElementById('btnCreate').disabled = true;
        showPopup("Tạo phòng thành công!");
        attachListeners(); // Gắn nút sau khi tạo
      }).catch(e => {
        console.error(e);
        showPopup("Lỗi tạo phòng: " + e.message, "error");
        currentRoomCode = null;
      });
    };

    // === Gắn nút + lắng nghe dữ liệu ===
    function attachListeners() {
      // Trạng thái
      onValue(ref(roomRef, 'lockedAnswer'), (snap) => {
        const locked = snap.val();
        const el = document.getElementById('statusAnswer');
        el.className = locked ? 'status-box locked' : 'status-box open';
        el.innerText = locked ? 'Đáp án: Đang khóa' : 'Đáp án: Đang mở';
      });

      onValue(ref(roomRef, 'lockedBuzz'), (snap) => {
        const locked = snap.val();
        const el = document.getElementById('statusBuzz');
        el.className = locked ? 'status-box locked' : 'status-box open';
        el.innerText = locked ? 'Chuông: Đang khóa' : 'Chuông: Đang mở';
      });

      // Danh sách đáp án
      onValue(ref(roomRef, 'answers'), (snap) => {
        const data = snap.val() || {};
        const tbl = document.getElementById('tblAnswers');
        tbl.innerHTML = '<tr><th>Tên</th><th>Đáp án</th><th>Thời gian</th></tr>';
        Object.values(data).sort((a, b) => a.ts - b.ts).forEach(x => {
          const tr = tbl.insertRow();
          tr.insertCell().innerText = x.name;
          tr.insertCell().innerText = x.answer;
          tr.insertCell().innerText = formatTime(x.ts, answerStartTime);
        });
      });

      // Thứ tự chuông
      onValue(ref(roomRef, 'buzzOrder'), (snap) => {
        const list = snap.val() || [];
        const ol = document.getElementById('buzzList');
        ol.innerHTML = '';
        Object.values(list).forEach(x => {
          const li = document.createElement('li');
          li.innerText = `${x.name} (${formatTime(x.ts, buzzStartTime)})`;
          ol.appendChild(li);
        });
      });

      // === GẮN SỰ KIỆN CHO CÁC NÚT ===
      document.getElementById('lockAnswers').onclick = lockAnswers;
      document.getElementById('unlockAnswersLimited').onclick = unlockAnswersLimited;
      document.getElementById('unlockAnswersPermanent').onclick = unlockAnswersPermanent;
      document.getElementById('resetAnswers').onclick = () => {
        set(ref(roomRef, 'answers'), {}).then(() => showPopup("Đã reset đáp án."));
      };

      document.getElementById('lockBuzz').onclick = lockBuzz;
      document.getElementById('unlockBuzzLimited').onclick = unlockBuzzLimited;
      document.getElementById('unlockBuzzPermanent').onclick = unlockBuzz;
      document.getElementById('resetBuzz').onclick = () => {
        set(ref(roomRef, 'buzzOrder'), []).then(() => showPopup("Đã reset chuông."));
      };
    }
  </script>
</body>

</html>