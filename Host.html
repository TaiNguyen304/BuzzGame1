<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Host Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      text-align: center;
      padding: 20px;
    }

    input,
    button,
    textarea {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      font-weight: bold;
    }

    table,
    th,
    td {
      border: 1px solid #aaa;
      border-collapse: collapse;
      padding: 8px;
      margin: 10px auto;
    }

    table {
      width: 90%;
      background: #fff;
    }

    th {
      background: #f0f0f0;
    }

    /* In ƒë·∫≠m c√°c √¥ gi√° tr·ªã trong b·∫£ng ƒë√°p √°n */
    #tblAnswers td {
      font-weight: bold;
    }

    ol {
      text-align: center;
      width: 550px;
      margin: 10px auto;
      background: #fff;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 6px;
      /* font-weight: bold;  <-- GI·ªÆ NGUY√äN N·∫æU MU·ªêN M·ªåI TH·ª® IN ƒê·∫¨M */
      word-wrap: break-word;
      overflow-wrap: break-word;
      list-style-position: inside;
    }
    
    /* === ƒêI·ªÄU CH·ªàNH: ƒê·∫£m b·∫£o c√°c gi√° tr·ªã trong buzz list l√† bold v√† k·∫ø th·ª´a Arial === */
    #buzzList li {
        font-weight: bold; 
    }
    /* === K·∫æT TH√öC ƒêI·ªÄU CH·ªàNH === */


    #roomInfo {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      transition: all 0.25s ease;
    }

    /* Th√™m style cho 3 n√∫t tr√™n c√πng */
    .top-buttons-group button {
      height: 40px;
      padding: 0 15px;
    }

    #btnCreate {
      background: purple;
      color: white;
    }

    /* Style cho n√∫t "Tham gia ph√≤ng (Qu·∫£n l√Ω)" */
    #btnJoinManager {
      background: blue;
      color: white;
    }

    /* Style cho n√∫t "Danh s√°ch tham gia" */
    #btnListUsers {
      background: yellow;
      color: black;
    }

    /* === TH√äM M·ªöI: CSS cho n√∫t Xu·∫•t k·∫øt qu·∫£ === */
    #btnExportResults {
      background: green;
      color: white;
      font-weight: bold;
    }
    /* === K·∫æT TH√öC TH√äM M·ªöI === */


    #unlockAnswersLimited,
    #unlockBuzzLimited {
      background: purple;
      color: white;
      font-weight: bold;
    }

    #unlockAnswersPermanent,
    #unlockBuzzPermanent {
      background: blue;
      color: white;
      font-weight: bold;
    }

    #lockAnswers,
    #lockBuzz {
      background: green;
      color: white;
      font-weight: bold;
    }

    #resetAnswers,
    #resetBuzz {
      background: yellow;
      color: black;
      font-weight: bold;
    }

    button:hover {
      background: #ff00cc !important;
      color: white !important;
    }

    .status-box {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 6px;
      margin: 5px;
      min-width: 160px;
      font-weight: bold;
      font-size: 17px;
    }

    .open {
      background: green;
      color: white;
      box-shadow: 0 0 10px green;
    }

    .locked {
      background: red;
      color: white;
    }

    #popupMessage {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: blue;
      color: white;
      padding: 15px 30px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s, top 0.5s;
      font-weight: bold;
    }

    .error {
      background-color: red;
      color: white;
      font-weight: bold;
    }

    .control-group {
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .control-item {
      display: flex;
      align-items: center;
    }

    .control-item label {
      font-weight: bold;
      margin-right: 10px;
    }

    /* Th√™m style cho ph·∫ßn hi·ªÉn th·ªã th·ªùi gian ch·∫°y */
    .time-elapsed-display {
      font-size: 1.1em;
      font-weight: bold;
      margin-top: 10px;
      height: 25px;
      /* Gi·ªØ ch·ªó ƒë·ªÉ tr√°nh nh·∫£y layout */
    }


    /* =================== Popup Styles =================== */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }

    .popup-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    .popup-content h3 {
      margin-top: 0;
    }

    .popup-inputs input {
      display: block;
      margin: 10px auto;
      width: 80%;
      max-width: 300px;
    }

    .popup-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    #btnConfirmManager {
      background: green;
      color: white;
    }

    #btnCloseJoin {
      background: red;
      color: white;
    }

    /* Styles cho Danh s√°ch tham gia */
    #userListContainer {
      max-height: 400px;
      overflow-y: auto;
      text-align: left;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 15px;
    }

    #userListContainer ul {
      list-style: none;
      padding: 0;
    }

    #userListContainer li {
      padding: 5px 0;
      border-bottom: 1px dotted #eee;
    }

    .role-host {
      color: blue;
      font-weight: bold;
    }

    .role-manager {
      color: red;
      font-weight: bold;
    }

    .role-contestant {
      color: black;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h1>Host Panel</h1>

  <div id="roomInfo"></div>

  <div class="top-buttons-group">
    <button id="btnCreate">T·∫°o ph√≤ng</button>
    <button id="btnJoinManager">Tham gia ph√≤ng (Qu·∫£n l√Ω)</button>
    <button id="btnListUsers">Danh s√°ch tham gia</button>
    <button id="btnExportResults">Xu·∫•t k·∫øt qu·∫£</button>
  </div>
  <br><br>

  <div>
    <div class="status-box locked" id="statusAnswer">ƒê√°p √°n: üîí ƒêang kh√≥a</div>
    <div class="status-box locked" id="statusBuzz">Chu√¥ng: üö´ ƒêang kh√≥a</div>
  </div>

  <div class="time-elapsed-display" id="answerTimeElapsed"></div>
  <div class="time-elapsed-display" id="buzzTimeElapsed"></div>

  <div class="control-group">
    <div class="control-item">
      <label for="answerDuration">Th·ªùi gian m·ªü ƒë√°p √°n (gi√¢y):</label>
      <input type="number" id="answerDuration" value="0" min="1" max="300" style="width: 80px; font-weight: bold;">
    </div>
    <div class="control-item">
      <label for="buzzDuration">Th·ªùi gian m·ªü chu√¥ng (gi√¢y):</label>
      <input type="number" id="buzzDuration" value="0" min="1" max="300" style="width: 80px; font-weight: bold;">
    </div>
  </div>

  <div style="margin-top: 5px;">
    <div>
      <button id="unlockAnswersLimited">M·ªü ƒë√°p √°n (Gi·ªõi h·∫°n)</button>
      <button id="unlockAnswersPermanent">M·ªü ƒë√°p √°n (Vƒ©nh vi·ªÖn)</button>
      <button id="lockAnswers">Kh√≥a ƒë√°p √°n</button>
      <button id="resetAnswers">Reset ƒë√°p √°n</button>
    </div>
  </div>

  <div style="margin-top: 5px;">
    <div>
      <button id="unlockBuzzLimited">M·ªü chu√¥ng (Gi·ªõi h·∫°n)</button>
      <button id="unlockBuzzPermanent">M·ªü chu√¥ng (Vƒ©nh vi·ªÖn)</button>
      <button id="lockBuzz">Kh√≥a chu√¥ng</button>
      <button id="resetBuzz">Reset chu√¥ng</button>
    </div>
  </div>
  <br>

  <h2>B·∫£ng k·∫øt qu·∫£ ƒë√°p √°n:</h2>
  <table id="tblAnswers">
    <thead>
      <tr>
        <th style="width: 30%;">T√™n</th>
        <th style="width: 50%;">ƒê√°p √°n</th>
        <th style="width: 20%;">Th·ªùi gian</th>
      </tr>
    </thead>
    <tbody>
      </tbody>
  </table>

  <h2>Th·ª© t·ª± b·∫•m chu√¥ng:</h2>
  <ol id="buzzList"></ol>

  <div id="popupMessage"></div>

  <div id="joinPopup" class="popup-overlay">
    <div class="popup-content">
      <h3>Tham gia ph√≤ng (Qu·∫£n l√Ω)</h3>
      <div class="popup-inputs">
        <input type="text" id="managerRoomCode" placeholder="M√£ ph√≤ng (6 s·ªë)">
        <input type="text" id="managerName" placeholder="T√™n qu·∫£n l√Ω">
      </div>
      <div class="popup-buttons">
        <button id="btnConfirmManager">X√°c nh·∫≠n</button>
        <button id="btnCloseJoin">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <div id="listPopup" class="popup-overlay">
    <div class="popup-content">
      <h3>Danh s√°ch tham gia</h3>
      <div id="userListContainer">
        <ul></ul>
      </div>
      <div class="popup-buttons">
        <button id="btnCloseList" style="background: red; color: white;">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    const SOCKET_SERVER_URL = "https://buzzgame1-1.onrender.com";
    const socket = io(SOCKET_SERVER_URL, { autoConnect: true });

    let currentRoom = null;
    let myName = "Host";
    let myRole = "Host";
    let answers = [];
    let buzzOrder = [];
    let lockedAnswer = true;
    let lockedBuzz = true;
    // Bi·∫øn l∆∞u startTime G·ªêC t·ª´ server (D√πng cho t√≠nh to√°n Excel)
    let answerStartTime = 0;
    let buzzStartTime = 0;
    let useLocalBuzzTime = false;
    // Bi·∫øn l∆∞u th√¥ng tin local ƒë·ªÉ t√≠nh th·ªùi gian c√≤n l·∫°i (ƒë·ªÉ ƒë·ªìng b·ªô)
    let answerDuration_host = 0;
    let answerEndTime_host = 0;
    let buzzDuration_host = 0;
    let buzzEndTime_host = 0;

    const answerDurationInput = document.getElementById("answerDuration");
    const buzzDurationInput = document.getElementById("buzzDuration");
    const tblAnswersBody = document.querySelector("#tblAnswers tbody");
    const buzzList = document.getElementById("buzzList");
    const roomInfo = document.getElementById("roomInfo");

    // ===========================================
    // ========== C√ÅC H√ÄM TI·ªÜN √çCH ================
    // ===========================================

    // H√†m hi·ªÉn th·ªã popup th√¥ng b√°o
    function showPopup(message, type = "success") {
      const popup = document.getElementById("popupMessage");
      popup.innerText = message;
      popup.classList.remove("error");
      if (type === "error") {
        popup.classList.add("error");
      }
      // Reset v·ªã tr√≠
      popup.style.top = "20px";
      popup.style.opacity = 1;

      setTimeout(() => {
        // Ch·ªâ ·∫©n ƒëi
        popup.style.opacity = 0;
        popup.style.top = "-50px";
      }, 3000);
    }

    // H√†m format th·ªùi gian (d√πng cho hi·ªÉn th·ªã tr√™n Host)
    function format(ms) {
      if (ms < 0) ms = 0;
      const totalSeconds = Math.floor(ms / 1000);
      const milliseconds = ms % 1000; // L·∫•y 3 ch·ªØ s·ªë th·∫≠p ph√¢n
      return `${totalSeconds.toString()}.${milliseconds.toString().padStart(3, '0')}s`;
    }

    // H√†m format th·ªùi gian (d√πng cho xu·∫•t Excel v√† hi·ªÉn th·ªã b·∫£ng)
    function formatTime(ts, startTime) {
        if (startTime === 0) return "0.000s"; // N·∫øu ch∆∞a c√≥ th·ªùi gian b·∫Øt ƒë·∫ßu
        
        const elapsed = ts - startTime; // Kho·∫£ng th·ªùi gian t√≠nh t·ª´ l√∫c b·∫Øt ƒë·∫ßu
        if (elapsed < 0) return "0.000s (L·ªói)";
        
        const totalSeconds = Math.floor(elapsed / 1000);
        const milliseconds = elapsed % 1000; // L·∫•y 3 ch·ªØ s·ªë th·∫≠p ph√¢n
        
        return `${totalSeconds.toString()}.${milliseconds.toString().padStart(3, '0')}s`;
    }

    // H√†m c·∫≠p nh·∫≠t hi·ªÉn th·ªã b·∫£ng ƒë√°p √°n
    function renderAnswers() {
      tblAnswersBody.innerHTML = ""; // X√≥a n·ªôi dung c≈©
      answers.sort((a, b) => a.ts - b.ts); // S·∫Øp x·∫øp theo th·ªùi gian g·ª≠i
      answers.forEach((item, index) => {
        const row = tblAnswersBody.insertRow();
        const timeElapsed = formatTime(item.ts, answerStartTime); // S·ª≠ d·ª•ng h√†m formatTime
        row.insertCell().innerText = item.name;
        row.insertCell().innerText = item.answer;
        row.insertCell().innerText = timeElapsed;
      });
    }

    // H√†m c·∫≠p nh·∫≠t hi·ªÉn th·ªã danh s√°ch chu√¥ng
    function renderBuzzList() {
      buzzList.innerHTML = ""; // X√≥a n·ªôi dung c≈©
      buzzOrder.sort((a, b) => a.ts - b.ts); // S·∫Øp x·∫øp theo th·ªùi gian b·∫•m
      buzzOrder.forEach((item, index) => {
        const timeElapsed = formatTime(item.ts, buzzStartTime); // S·ª≠ d·ª•ng h√†m formatTime
        const li = document.createElement("li");
        li.innerText = `${item.name} - ${timeElapsed}`;
        buzzList.appendChild(li);
      });
    }

    // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë√≥ng/m·ªü
    function updateStatusDisplay() {
      const sA = document.getElementById("statusAnswer");
      const sB = document.getElementById("statusBuzz");
      sA.className = lockedAnswer ? "status-box locked" : "status-box open";
      sA.innerText = lockedAnswer ? "ƒê√°p √°n: üîí ƒêang kh√≥a" : "ƒê√°p √°n: üîì ƒêang m·ªü";
      sB.className = lockedBuzz ? "status-box locked" : "status-box open";
      sB.innerText = lockedBuzz ? "Chu√¥ng: üö´ ƒêang kh√≥a" : "Chu√¥ng: üîî ƒêang m·ªü";
    }

    // H√†m c·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªùi gian ƒë√£ tr√¥i qua/c√≤n l·∫°i
    function updateElapsedDisplay() {
      const now = Date.now();
      const aDisp = document.getElementById("answerTimeElapsed");
      const bDisp = document.getElementById("buzzTimeElapsed");

      // ƒê·ªìng h·ªì ƒë√°p √°n
      if (!lockedAnswer && answerDuration_host === 0) {
        // M·ªü vƒ©nh vi·ªÖn (kh√¥ng c·∫ßn hi·ªÉn th·ªã)
        aDisp.innerHTML = "";
      } else if (!lockedAnswer && answerDuration_host > 0 && answerEndTime_host > 0) {
        // THAY ƒê·ªîI: D√πng answerEndTime_host (t√≠nh theo ƒë·ªìng h·ªì local)
        const remain = answerEndTime_host - now;
        aDisp.innerHTML = `Th·ªùi gian g·ª≠i ƒë√°p √°n c√≤n l·∫°i: <span style="color:red;">${format(remain)}</span>`;
      } else {
        aDisp.innerHTML = "";
      }

      // ƒê·ªìng h·ªì chu√¥ng
      if (!lockedBuzz && buzzDuration_host === 0) {
        // M·ªü vƒ©nh vi·ªÖn (kh√¥ng c·∫ßn hi·ªÉn th·ªã)
        bDisp.innerHTML = "";
      } else if (!lockedBuzz && buzzDuration_host > 0 && buzzEndTime_host > 0) {
        // THAY ƒê·ªîI: D√πng buzzEndTime_host (t√≠nh theo ƒë·ªìng h·ªì local)
        const remain = buzzEndTime_host - now;
        bDisp.innerHTML = `Th·ªùi gian b·∫•m chu√¥ng c√≤n l·∫°i: <span style="color:red;">${format(remain)}</span>`;
      } else {
        bDisp.innerHTML = "";
      }
    }

    // Thi·∫øt l·∫≠p interval c·∫≠p nh·∫≠t th·ªùi gian
    setInterval(updateElapsedDisplay, 100); // C·∫≠p nh·∫≠t m·ªói 100ms

    // H√†m hi·ªÉn th·ªã danh s√°ch ng∆∞·ªùi d√πng
    function renderUserList(host, managers, contestants) {
      const ul = document.querySelector("#userListContainer ul");
      ul.innerHTML = "";

      // Host
      if (host) {
        const li = document.createElement("li");
        const isSelf = host.id === socket.id;
        li.innerHTML = `${isSelf ? `(B·∫°n) ` : ''}<b>${host.name}</b> <span class="role-host">(Host)</span>`;
        ul.appendChild(li);
      }

      // Managers
      managers.forEach(m => {
        const li = document.createElement("li");
        const isSelf = m.id === socket.id;
        li.innerHTML = `${isSelf ? `(B·∫°n) ` : ''}<b>${m.name}</b> <span class="role-manager">(Qu·∫£n l√Ω)</span>`;
        ul.appendChild(li);
      });

      // Contestants
      contestants.forEach(c => {
        const li = document.createElement("li");
        li.innerHTML = `<b>${c.name}</b> <span class="role-contestant">(Th√≠ sinh)</span>`;
        ul.appendChild(li);
      });
    }

    // H√†m xu·∫•t k·∫øt qu·∫£ ra Excel
    document.getElementById("btnExportResults").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o/tham gia ph√≤ng tr∆∞·ªõc!", "error");
      if (typeof XLSX === 'undefined') return showPopup("L·ªói: Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán Excel (XLSX).", "error");

      // 1. Chu·∫©n b·ªã d·ªØ li·ªáu cho Sheet 1: ƒê√°p √°n
      const ws1_data = [
        ["T√™n ng∆∞·ªùi ch∆°i", "ƒê√°p √°n", "Th·ªùi gian"] // H√†ng ti√™u ƒë·ªÅ
      ];
      answers.forEach(x => {
        ws1_data.push([
          x.name,
          x.answer,
          // D√πng startTime (g·ªëc) ƒë·ªÉ t√≠nh to√°n. KH√îNG TH√äM 's' v√¨ Excel n√™n l√† s·ªë
          formatTime(x.ts, answerStartTime).replace('s', '')
        ]);
      });

      // 2. Chu·∫©n b·ªã d·ªØ li·ªáu cho Sheet 2: B·∫•m chu√¥ng
      const ws2_data = [
        ["T√™n ng∆∞·ªùi ch∆°i", "Th·ªùi gian b·∫•m chu√¥ng"] // H√†ng ti√™u ƒë·ªÅ
      ];
      buzzOrder.forEach(x => {
        ws2_data.push([
          x.name,
          // D√πng startTime (g·ªëc) ƒë·ªÉ t√≠nh to√°n. KH√îNG TH√äM 's' v√¨ Excel n√™n l√† s·ªë
          formatTime(x.ts, buzzStartTime).replace('s', '')
        ]);
      });

      // 3. T·∫°o Workbook
      const wb = XLSX.utils.book_new();

      // T·∫°o Sheet 1
      const ws1 = XLSX.utils.aoa_to_sheet(ws1_data);
      XLSX.utils.book_append_sheet(wb, ws1, "KetQua_DapAn");

      // T·∫°o Sheet 2
      const ws2 = XLSX.utils.aoa_to_sheet(ws2_data);
      XLSX.utils.book_append_sheet(wb, ws2, "KetQua_Buzz");

      // 4. T·∫£i file
      const filename = `KetQua_Phong_${currentRoom}_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.xlsx`;
      XLSX.writeFile(wb, filename);
      showPopup("ƒê√£ xu·∫•t k·∫øt qu·∫£ ra file Excel!");
    };


    // ===========================================
    // ============ SOCKET.IO LOGIC ==============
    // ===========================================

    // L·∫Øng nghe khi k·∫øt n·ªëi
    socket.on("connect", () => {
      console.log("Connected to server. ID:", socket.id);
      if (currentRoom) {
        // X·ª≠ l√Ω reconnect n·∫øu c·∫ßn
      }
    });

    // L·∫Øng nghe khi t·∫°o ph√≤ng
    socket.on("room-created", (data) => {
      currentRoom = data.roomCode;
      myName = "Host";
      myRole = "Host";
      roomInfo.innerText = `Ph√≤ng: ${currentRoom} | Vai tr√≤: Host`;
      // C·∫≠p nh·∫≠t d·ªØ li·ªáu c≈© n·∫øu c√≥ (tr∆∞·ªùng h·ª£p re-host)
      answers = data.answers || [];
      buzzOrder = data.buzzOrder || [];
      renderAnswers();
      renderBuzzList();
      showPopup(`ƒê√£ t·∫°o ph√≤ng ${currentRoom}`);
    });

    // L·∫Øng nghe khi tham gia ph√≤ng v·ªõi vai tr√≤ Qu·∫£n l√Ω th√†nh c√¥ng
    socket.on("manager-join-success", (data) => {
      currentRoom = data.roomCode;
      myName = data.name;
      myRole = "Manager";
      roomInfo.innerText = `Ph√≤ng: ${currentRoom} | Vai tr√≤: Qu·∫£n l√Ω (${myName})`;
      // C·∫≠p nh·∫≠t d·ªØ li·ªáu c≈©
      answers = data.answers || [];
      buzzOrder = data.buzzOrder || [];
      renderAnswers();
      renderBuzzList();
      document.getElementById("joinPopup").style.display = "none";
      showPopup(`Tham gia ph√≤ng ${currentRoom} th√†nh c√¥ng v·ªõi vai tr√≤ Qu·∫£n l√Ω!`);
    });

    // L·∫Øng nghe l·ªói khi tham gia
    socket.on("join-error", (message) => {
      showPopup(message, "error");
    });

    // ========== Nh·∫≠n d·ªØ li·ªáu ==========
    socket.on("host-new-answer", data => {
      const idx = answers.findIndex(x => x.name === data.name);
      if (idx >= 0) answers[idx] = data;
      else answers.push(data);
      renderAnswers();
    });

    socket.on("host-new-buzz", data => {
      if (!buzzOrder.find(b => b.name === data.name)) {
        data.localTimestamp = Date.now();
        buzzOrder.push(data);
      }
      renderBuzzList();
    });

    // ========== ƒê·ªìng b·ªô h√≥a Reset ƒê√°p √°n ==========
    socket.on("answers-reset", () => {
      answers = [];
      renderAnswers();
      showPopup("ƒê√°p √°n ƒë√£ ƒë∆∞·ª£c Host/Manager reset!");
    });

    // ========== ƒê·ªìng b·ªô h√≥a Reset Chu√¥ng ==========
    socket.on("buzz-reset", () => {
      buzzOrder = [];
      useLocalBuzzTime = true;
      buzzStartTime = Date.now();
      renderBuzzList();
      showPopup("Chu√¥ng ƒë√£ ƒë∆∞·ª£c Host/Manager reset!");
    });

    // ========== ƒêi·ªÅu khi·ªÉn ƒê√°p √°n ==========
    document.getElementById("unlockAnswersLimited").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o/tham gia ph√≤ng tr∆∞·ªõc!", "error");
      const duration = Math.max(1, parseInt(answerDurationInput.value) || 0);
      socket.emit("host-toggle-answer", { roomCode: currentRoom, state: "open", duration });
    };

    document.getElementById("unlockAnswersPermanent").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o/tham gia ph√≤ng tr∆∞·ªõc!", "error");
      socket.emit("host-toggle-answer", { roomCode: currentRoom, state: "open", duration: 0 });
    };

    document.getElementById("lockAnswers").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o/tham gia ph√≤ng tr∆∞·ªõc!", "error");
      socket.emit("host-toggle-answer", { roomCode: currentRoom, state: "locked" });
    };

    document.getElementById("resetAnswers").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o/tham gia ph√≤ng tr∆∞·ªõc!", "error");
      // G·ª≠i y√™u c·∫ßu reset l√™n server, server s·∫Ω x·ª≠ l√Ω x√≥a data v√† broadcast l·∫°i cho t·∫•t c·∫£
      socket.emit("host-reset-answers", currentRoom);
    };

    // ========== ƒêi·ªÅu khi·ªÉn Chu√¥ng ==========
    document.getElementById("unlockBuzzLimited").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o/tham gia ph√≤ng tr∆∞·ªõc!", "error");
      const duration = Math.max(1, parseInt(buzzDurationInput.value) || 0);
      socket.emit("host-toggle-buzz", { roomCode: currentRoom, state: "open", duration });
    };

    document.getElementById("unlockBuzzPermanent").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o/tham gia ph√≤ng tr∆∞·ªõc!", "error");
      socket.emit("host-toggle-buzz", { roomCode: currentRoom, state: "open", duration: 0 });
    };

    document.getElementById("lockBuzz").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o/tham gia ph√≤ng tr∆∞·ªõc!", "error");
      socket.emit("host-toggle-buzz", { roomCode: currentRoom, state: "locked" });
    };

    document.getElementById("resetBuzz").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o/tham gia ph√≤ng tr∆∞·ªõc!", "error");
      // G·ª≠i y√™u c·∫ßu reset l√™n server, server s·∫Ω x·ª≠ l√Ω x√≥a data v√† broadcast l·∫°i cho t·∫•t c·∫£
      socket.emit("host-reset-buzz", currentRoom);
    };


    // ========== C·∫≠p nh·∫≠t tr·∫°ng th√°i t·ª´ Server ==========
    socket.on("answer-status-changed", ({ state, duration, startTime }) => {
      lockedAnswer = state === "locked";
      answerDuration_host = duration || 0; // L∆∞u duration
      if (state === "open") {
        // Lu√¥n l∆∞u startTime G·ªêC c·ªßa server (cho Excel)
        answerStartTime = startTime || 0;
        if (answerDuration_host > 0) {
          // T√≠nh th·ªùi ƒëi·ªÉm k·∫øt th√∫c THEO ƒê·ªíNG H·ªí HOST
          answerEndTime_host = Date.now() + (answerDuration_host * 1000);
        } else {
          answerEndTime_host = 0;
        }
      }
      updateStatusDisplay();
      showPopup(`ƒê√°p √°n: ${lockedAnswer ? 'ƒê√£ Kh√≥a' : 'ƒê√£ M·ªü'}`);
    });

    socket.on("buzz-status-changed", ({ state, duration, startTime }) => {
      lockedBuzz = state === "locked";
      buzzDuration_host = duration || 0; // L∆∞u duration
      if (state === "open") {
        // Lu√¥n l∆∞u startTime G·ªêC c·ªßa server (cho Excel)
        buzzStartTime = startTime || 0;
        if (buzzDuration_host > 0) {
          // T√≠nh th·ªùi ƒëi·ªÉm k·∫øt th√∫c THEO ƒê·ªíNG H·ªí HOST
          buzzEndTime_host = Date.now() + (buzzDuration_host * 1000);
        } else {
          buzzEndTime_host = 0;
        }
      }
      updateStatusDisplay();
      showPopup(`Chu√¥ng: ${lockedBuzz ? 'ƒê√£ Kh√≥a' : 'ƒê√£ M·ªü'}`);
    });

    // ========== T·∫†O PH√íNG ==========
    document.getElementById("btnCreate").onclick = () => {
      const roomCode = Math.floor(100000 + Math.random() * 900000);
      socket.emit("host-create-room", roomCode);
    };

    // ========== POPUP Tham gia ph√≤ng (Qu·∫£n l√Ω) ==========
    document.getElementById("btnJoinManager").onclick = () => {
      document.getElementById("joinPopup").style.display = "flex";
      document.getElementById("managerRoomCode").value = currentRoom || "";
      document.getElementById("managerName").value = myName === "Host" ? "" : myName;
    };

    document.getElementById("btnCloseJoin").onclick = () => {
      document.getElementById("joinPopup").style.display = "none";
    };

    document.getElementById("btnConfirmManager").onclick = () => {
      const code = document.getElementById("managerRoomCode").value.trim();
      const name = document.getElementById("managerName").value.trim();

      if (code.length !== 6 || isNaN(code)) {
        return showPopup("M√£ ph√≤ng ph·∫£i l√† 6 ch·ªØ s·ªë!", "error");
      }
      if (name.length < 1) {
        return showPopup("Vui l√≤ng nh·∫≠p T√™n qu·∫£n l√Ω!", "error");
      }

      socket.emit("manager-join-room", { roomCode: parseInt(code), name });
    };

    // ========== POPUP Danh s√°ch tham gia ==========\
    document.getElementById("btnListUsers").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o/tham gia ph√≤ng tr∆∞·ªõc!", "error");
      socket.emit("host-get-users", currentRoom);
      document.getElementById("listPopup").style.display = "flex";
    };

    document.getElementById("btnCloseList").onclick = () => {
      document.getElementById("listPopup").style.display = "none";
    };

    socket.on("host-all-users", ({ host, managers, contestants }) => {
      renderUserList(host, managers, contestants);
    });

    // Th√™m ng∆∞·ªùi d√πng m·ªõi
    socket.on("host-new-user", (user) => {
      // Y√™u c·∫ßu c·∫≠p nh·∫≠t l·∫°i danh s√°ch khi c√≥ ng∆∞·ªùi m·ªõi
      socket.emit("host-get-users", currentRoom);
      showPopup(`[${user.role}] ${user.name} ƒë√£ tham gia ph√≤ng.`);
    });

    // Ng∆∞·ªùi d√πng r·ªùi ƒëi
    socket.on("host-user-left", (user) => {
      // Y√™u c·∫ßu c·∫≠p nh·∫≠t l·∫°i danh s√°ch khi c√≥ ng∆∞·ªùi r·ªùi ƒëi
      socket.emit("host-get-users", currentRoom);
      showPopup(`[${user.role}] ƒë√£ r·ªùi ph√≤ng.`, 'error'); // Kh√¥ng c√≥ t√™n, hi·ªÉn th·ªã chung
    });

    // ========== T·∫†O PH√íNG BAN ƒê·∫¶U (N·∫æU CH∆ØA C√ì) ==========
    document.getElementById("btnCreate").onclick = () => {
      const roomCode = Math.floor(100000 + Math.random() * 900000); // M√£ ph√≤ng 6 ch·ªØ s·ªë
      socket.emit("host-create-room", roomCode);
    };
  </script>
</body>

</html>