<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Host Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      text-align: center;
      padding: 20px;
    }

    input,
    button,
    textarea {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      font-weight: bold;
    }

    table,
    th,
    td {
      border: 1px solid #aaa;
      border-collapse: collapse;
      padding: 8px;
      margin: 10px auto;
    }

    table {
      width: 90%;
      background: #fff;
    }

    th {
      background: #f0f0f0;
    }

    ol {
      text-align: left;
      width: 300px;
      margin: 10px auto;
      background: #fff;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 6px;
    }

    #roomInfo {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    /* ======= N√∫t ƒëi·ªÅu khi·ªÉn ======= */
    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      transition: all 0.25s ease;
    }

    #btnCreate {
      background: aqua;
      color: black;
    }

    #unlockAnswers,
    #unlockBuzz {
      background: blue;
      color: white;
      font-weight: bold;
    }

    #lockAnswers,
    #lockBuzz {
      background: green;
      color: white;
      font-weight: bold;
    }

    #resetAnswers,
    #resetBuzz {
      background: yellow;
      color: black;
      font-weight: bold;
    }

    button:hover {
      background: #ff00cc !important;
      color: white !important;
    }

    /* ======= Tr·∫°ng th√°i hi·ªÉn th·ªã ======= */
    .status-box {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 6px;
      margin: 5px;
      min-width: 160px;
      font-weight: bold;
      font-size: 17px;
      background: #ddd;
    }

    .open {
      background: #39ff14;
      color: black;
      box-shadow: 0 0 10px green;
    }

    .locked {
      background: red;
      color: white;
    }

    /* ======= Popup th√¥ng b√°o ======= */
    #popupMessage {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: green;
      color: white;
      padding: 15px 30px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s, top 0.5s;
    }

    .error {
      background-color: red;
      color: white;
      font-weight: bold;
    }
    
    /* CSS m·ªõi cho √¥ nh·∫≠p th·ªùi gian */
    .control-group {
      margin-bottom: 15px;
    }
    .control-group label {
      font-weight: bold;
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <h1>Host Panel</h1>

  <div id="roomInfo"></div>
  <button id="btnCreate">T·∫°o ph√≤ng</button><br><br>

  <div>
    <div class="status-box locked" id="statusAnswer">ƒê√°p √°n: üîí ƒêang kh√≥a</div>
    <div class="status-box locked" id="statusBuzz">Chu√¥ng: üö´ ƒêang kh√≥a</div>
  </div><br>

  <div class="control-group">
    <label for="answerDuration">Th·ªùi gian m·ªü ƒë√°p √°n (gi√¢y):</label>
    <input type="number" id="answerDuration" value="15" min="1" max="300" style="width: 80px; font-weight: bold;">
  </div>
  <button id="unlockAnswers">M·ªü ƒë√°p √°n</button>
  <button id="lockAnswers">Kh√≥a ƒë√°p √°n</button>
  <button id="resetAnswers">Reset ƒë√°p √°n</button>

  <br>

  <button id="unlockBuzz">M·ªü chu√¥ng</button>
  <button id="lockBuzz">Kh√≥a chu√¥ng</button>
  <button id="resetBuzz">Reset chu√¥ng</button>

  <h2>ƒê√°p √°n (l·∫ßn g·ª≠i g·∫ßn nh·∫•t):</h2>
  <table id="tblAnswers">
    <tr>
      <th>T√™n</th>
      <th>ƒê√°p √°n</th>
      <th>Th·ªùi gian</th>
    </tr>
  </table>

  <h2>Th·ª© t·ª± b·∫•m chu√¥ng:</h2>
  <ol id="buzzList"></ol>

  <div id="popupMessage"></div>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyAKTVuijDV4QfHjDcnEau2w9MaRL9YduEQ",
      authDomain: "buzz-game-7c91c.firebaseapp.com",
      projectId: "buzz-game-7c91c",
      storageBucket: "buzz-game-7c91c.firebasestorage.app",
      messagingSenderId: "946217092381",
      appId: "1:946217092381:web:d81064145965fb151acdf4",
      measurementId: "G-C7KG9KSJ9C"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    // L∆∞u √Ω: ƒê·∫£m b·∫£o ƒë√£ import v√† kh·ªüi t·∫°o Firebase Database ƒë√∫ng c√°ch (v√≠ d·ª•: `const db = getDatabase(app);` n·∫øu d√πng modular API)
    // T√¥i gi·ªØ nguy√™n c·∫•u tr√∫c c≈© c·ªßa b·∫°n:
    const db = firebase.database();
    let roomRef;
    let currentRoomCode = null;
    let answerTimeout = null; // Bi·∫øn l∆∞u ID c·ªßa setTimeout ƒë·ªÉ qu·∫£n l√Ω vi·ªác t·ª± ƒë·ªông kh√≥a

    // ====== Popup hi·ªÉn th·ªã ======
    function showPopup(message, type = 'success') {
      const popup = document.getElementById('popupMessage');
      popup.innerText = message;
      if (type === 'error') popup.classList.add('error');
      else popup.classList.remove('error');

      popup.style.transition = 'none';
      popup.style.opacity = '0';
      popup.style.top = '20px';
      void popup.offsetHeight;

      popup.style.transition = 'opacity 0.5s, top 0.5s';
      popup.style.opacity = '1';
      popup.style.top = '40px';
      setTimeout(() => {
        popup.style.opacity = '0';
        popup.style.top = '20px';
      }, 3000);
    }

    function generateRoomCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }
    
    // H√†m kh√≥a ƒë√°p √°n (c√≥ b·ªï sung x√≥a timeout)
    function lockAnswers() {
      if (!roomRef) return;
      roomRef.child('lockedAnswer').set(true).then(() => {
        showPopup("ƒê√£ kh√≥a ƒë√°p √°n.");
      });
      // X√≥a b·ªô ƒë·∫øm ng∆∞·ª£c t·ª± ƒë·ªông kh√≥a n·∫øu c√≥
      if (answerTimeout) {
        clearTimeout(answerTimeout);
        answerTimeout = null;
      }
    }

    // H√†m m·ªü ƒë√°p √°n theo th·ªùi gian (m·ªõi)
    function timedUnlockAnswers() {
      if (!roomRef) {
        showPopup("Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc.", "error");
        return;
      }

      // 1. X√≥a b·ªô ƒë·∫øm ng∆∞·ª£c t·ª± ƒë·ªông kh√≥a hi·ªán t·∫°i (n·∫øu ƒëang ch·∫°y)
      if (answerTimeout) {
        clearTimeout(answerTimeout);
        answerTimeout = null;
      }

      const durationInput = document.getElementById('answerDuration');
      const durationSeconds = parseInt(durationInput.value);

      if (isNaN(durationSeconds) || durationSeconds <= 0) {
        showPopup("Th·ªùi gian m·ªü ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng l·ªõn h∆°n 0.", 'error');
        return;
      }

      // 2. M·ªü ƒë√°p √°n tr√™n Firebase
      roomRef.child('lockedAnswer').set(false).then(() => {
        showPopup(`ƒê√£ m·ªü ƒë√°p √°n trong ${durationSeconds} gi√¢y!`);
      }).catch(error => {
        console.error("L·ªói khi m·ªü ƒë√°p √°n:", error);
        showPopup("L·ªói khi m·ªü ƒë√°p √°n.", "error");
        return;
      });

      // 3. Thi·∫øt l·∫≠p timeout ƒë·ªÉ t·ª± ƒë·ªông kh√≥a
      answerTimeout = setTimeout(() => {
        if (!roomRef) return; // Ki·ªÉm tra an to√†n
        roomRef.child('lockedAnswer').set(true).then(() => {
          showPopup("H·∫øt gi·ªù. ƒê√°p √°n ƒë√£ t·ª± ƒë·ªông kh√≥a.");
        });
        answerTimeout = null; // Timer ƒë√£ k·∫øt th√∫c
      }, durationSeconds * 1000); // Chuy·ªÉn gi√¢y sang mili gi√¢y
    }


    document.getElementById('btnCreate').onclick = () => {
      if (currentRoomCode) {
        showPopup("Ph√≤ng ƒë√£ ƒë∆∞·ª£c t·∫°o. M√£ ph√≤ng: " + currentRoomCode, "error");
        return;
      }

      const code = generateRoomCode();
      currentRoomCode = code;
      document.getElementById('roomInfo').innerHTML = `üîë <b>M√£ ph√≤ng:</b> <span style="color:black;">${code}</span>`;

      roomRef = db.ref('rooms/' + code);
      roomRef.set({
        answers: {},
        buzzOrder: [],
        lockedAnswer: true,
        lockedBuzz: true
      }).then(() => {
        document.getElementById('btnCreate').disabled = true;
        showPopup("ƒê√£ t·∫°o ph√≤ng th√†nh c√¥ng! M√£ ph√≤ng: " + code);
        attachListeners();
      }).catch(error => {
        console.error("L·ªói khi t·∫°o ph√≤ng:", error);
        showPopup("L·ªói khi t·∫°o ph√≤ng.", "error");
        currentRoomCode = null;
      });
    };

    function attachListeners() {
      const statusAnswer = document.getElementById('statusAnswer');
      const statusBuzz = document.getElementById('statusBuzz');

      roomRef.child('lockedAnswer').on('value', snap => {
        const val = snap.val();
        const locked = val === true || val === "true";
        if (locked) {
          statusAnswer.className = 'status-box locked';
          statusAnswer.innerText = 'ƒê√°p √°n: üîí ƒêang kh√≥a';
        } else {
          statusAnswer.className = 'status-box open';
          statusAnswer.innerText = 'ƒê√°p √°n: üîì ƒêang m·ªü';
        }
      });

      roomRef.child('lockedBuzz').on('value', snap => {
        const val = snap.val();
        const locked = val === true || val === "true";
        if (locked) {
          statusBuzz.className = 'status-box locked';
          statusBuzz.innerText = 'Chu√¥ng: üö´ ƒêang kh√≥a';
        } else {
          statusBuzz.className = 'status-box open';
          statusBuzz.innerText = 'Chu√¥ng: üîî ƒêang m·ªü';
        }
      });

      roomRef.child('answers').on('value', snap => {
        const obj = snap.val() || {};
        const tbl = document.getElementById('tblAnswers');
        tbl.innerHTML = '<tr><th>T√™n</th><th>ƒê√°p √°n</th><th>Th·ªùi gian</th></tr>';
        // S·∫Øp x·∫øp theo timestamp (ts)
        Object.values(obj).sort((a, b) => a.ts - b.ts).forEach(x => {
          const tr = tbl.insertRow();
          tr.insertCell().innerText = x.name;
          tr.insertCell().innerText = x.answer;
          tr.insertCell().innerText = new Date(x.ts).toLocaleTimeString();
        });
      });

      roomRef.child('buzzOrder').on('value', snap => {
        const list = snap.val() || [];
        const ol = document.getElementById('buzzList');
        ol.innerHTML = '';
        list.forEach(x => {
          const li = document.createElement('li');
          li.innerText = x.name + ' (' + new Date(x.ts).toLocaleTimeString() + ')';
          ol.appendChild(li);
        });
      });

      // C√°c n√∫t ƒëi·ªÅu khi·ªÉn
      // G√°n l·∫°i cho c√°c h√†m m·ªõi
      document.getElementById('lockAnswers').onclick = lockAnswers;
      document.getElementById('unlockAnswers').onclick = timedUnlockAnswers;
      document.getElementById('resetAnswers').onclick = () => { roomRef.child('answers').set({}); showPopup("ƒê√£ reset danh s√°ch ƒë√°p √°n."); };

      document.getElementById('lockBuzz').onclick = () => { roomRef.child('lockedBuzz').set(true); showPopup("ƒê√£ kh√≥a chu√¥ng."); };
      document.getElementById('unlockBuzz').onclick = () => { roomRef.child('lockedBuzz').set(false); showPopup("ƒê√£ m·ªü chu√¥ng!"); };
      document.getElementById('resetBuzz').onclick = () => { roomRef.child('buzzOrder').set([]); showPopup("ƒê√£ reset th·ª© t·ª± chu√¥ng."); };
    }
  </script>
</body>

</html>