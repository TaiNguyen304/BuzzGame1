<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Host Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      text-align: center;
      padding: 20px;
    }

    input,
    button,
    textarea {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      font-weight: bold;
    }

    table,
    th,
    td {
      border: 1px solid #aaa;
      border-collapse: collapse;
      padding: 8px;
      margin: 10px auto;
    }

    table {
      width: 90%;
      background: #fff;
    }

    th {
      background: #f0f0f0;
    }

    /* In ƒë·∫≠m c√°c √¥ gi√° tr·ªã trong b·∫£ng ƒë√°p √°n */
    #tblAnswers td {
      font-weight: bold;
    }

    ol {
      text-align: center;
      width: 550px;
      margin: 10px auto;
      background: #fff;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 6px;
      font-weight: bold;
      word-wrap: break-word;
      overflow-wrap: break-word;
      list-style-position: inside;
    }

    #roomInfo {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      transition: all 0.25s ease;
    }

    #btnCreate {
      background: purple;
      color: white;
    }

    #unlockAnswersLimited,
    #unlockBuzzLimited {
      background: purple;
      color: white;
      font-weight: bold;
    }

    #unlockAnswersPermanent,
    #unlockBuzzPermanent {
      background: blue;
      color: white;
      font-weight: bold;
    }

    #lockAnswers,
    #lockBuzz {
      background: green;
      color: white;
      font-weight: bold;
    }

    #resetAnswers,
    #resetBuzz {
      background: yellow;
      color: black;
      font-weight: bold;
    }

    button:hover {
      background: #ff00cc !important;
      color: white !important;
    }

    .status-box {
      display: inline-block;
      padding: 8px 15px;
      border-radius: 6px;
      margin: 5px;
      min-width: 160px;
      font-weight: bold;
      font-size: 17px;
    }

    .open {
      background: green;
      color: white;
      box-shadow: 0 0 10px green;
    }

    .locked {
      background: red;
      color: white;
    }

    #popupMessage {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: blue;
      color: white;
      padding: 15px 30px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s, top 0.5s;
      font-weight: bold;
    }

    .error {
      background-color: red;
      color: white;
      font-weight: bold;
    }

    .control-group {
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .control-item {
      display: flex;
      align-items: center;
    }

    .control-item label {
      font-weight: bold;
      margin-right: 10px;
    }

    /* Th√™m style cho ph·∫ßn hi·ªÉn th·ªã th·ªùi gian ch·∫°y */
    .time-elapsed-display {
      font-size: 1.1em;
      font-weight: bold;
      margin-top: 10px;
      height: 25px; /* Gi·ªØ ch·ªó ƒë·ªÉ tr√°nh nh·∫£y layout */
    }
  </style>
</head>

<body>
  <h1>Host Panel</h1>

  <div id="roomInfo"></div>
  <button id="btnCreate">T·∫°o ph√≤ng</button><br><br>

  <div>
    <div class="status-box locked" id="statusAnswer">ƒê√°p √°n: üîí ƒêang kh√≥a</div>
    <div class="status-box locked" id="statusBuzz">Chu√¥ng: üö´ ƒêang kh√≥a</div>
  </div>
  
  <div class="time-elapsed-display" id="answerTimeElapsed"></div>
  <div class="time-elapsed-display" id="buzzTimeElapsed"></div>

  <div class="control-group">
    <div class="control-item">
      <label for="answerDuration">Th·ªùi gian m·ªü ƒë√°p √°n (gi√¢y):</label>
      <input type="number" id="answerDuration" value="0" min="1" max="300" style="width: 80px; font-weight: bold;">
    </div>
    <div class="control-item">
      <label for="buzzDuration">Th·ªùi gian m·ªü chu√¥ng (gi√¢y):</label>
      <input type="number" id="buzzDuration" value="0" min="1" max="300" style="width: 80px; font-weight: bold;">
    </div>
  </div>

  <button id="unlockAnswersLimited">M·ªü ƒë√°p √°n (Gi·ªõi h·∫°n)</button>
  <button id="unlockAnswersPermanent">M·ªü ƒë√°p √°n (Vƒ©nh vi·ªÖn)</button>
  <button id="lockAnswers">Kh√≥a ƒë√°p √°n</button>
  <button id="resetAnswers">Reset ƒë√°p √°n</button>

  <br>

  <button id="unlockBuzzLimited">M·ªü chu√¥ng (Gi·ªõi h·∫°n)</button>
  <button id="unlockBuzzPermanent">M·ªü chu√¥ng (Vƒ©nh vi·ªÖn)</button>
  <button id="lockBuzz">Kh√≥a chu√¥ng</button>
  <button id="resetBuzz">Reset chu√¥ng</button>

  <h2>ƒê√°p √°n (l·∫ßn g·ª≠i g·∫ßn nh·∫•t):</h2>
  <table id="tblAnswers">
    <tr>
      <th>T√™n</th>
      <th>ƒê√°p √°n</th>
      <th>Th·ªùi gian</th>
    </tr>
  </table>

  <h2>Th·ª© t·ª± b·∫•m chu√¥ng:</h2>
  <ol id="buzzList"></ol>

  <div id="popupMessage"></div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <script>
    const SOCKET_SERVER_URL = "https://buzzgame1-1.onrender.com";
    const socket = io(SOCKET_SERVER_URL, { autoConnect: true });

    let answers = [];
    let buzzOrder = [];
    let lockedAnswer = true;
    let lockedBuzz = true;
    let answerStartTime = 0;
    let buzzStartTime = 0;
    let answerDuration_host = 0; // Th√™m: L∆∞u tr·ªØ th·ªùi l∆∞·ª£ng ƒë√°p √°n
    let buzzDuration_host = 0; // Th√™m: L∆∞u tr·ªØ th·ªùi l∆∞·ª£ng chu√¥ng
    let hostTimerInterval = null; // Th√™m: Interval ƒë·ªÉ c·∫≠p nh·∫≠t th·ªùi gian
    let currentRoom = null;

    // H√†m ƒë·ªãnh d·∫°ng th·ªùi gian (D√πng chung cho c·∫£ elapsed v√† remaining)
    function format(ms) {
        return (Math.max(0,ms)/1000).toFixed(3)+"s";
    }

    function formatTime(ts, start) {
      if (!start) return "N/A";
      return ((ts - start) / 1000).toFixed(3) + "s";
    }

    function showPopup(msg, type = "success") {
      const p = document.getElementById("popupMessage");
      p.innerText = msg;
      p.classList.toggle("error", type === "error");
      p.style.opacity = "0";
      p.style.top = "20px";
      void p.offsetHeight;
      p.style.opacity = "1";
      p.style.top = "40px";
      setTimeout(() => { p.style.opacity = "0"; p.style.top = "20px"; }, 3000);
    }

    function renderAnswers() {
      const tbl = document.getElementById("tblAnswers");
      tbl.innerHTML = `<tr><th>T√™n</th><th>ƒê√°p √°n</th><th>Th·ªùi gian</th></tr>`;
      answers.sort((a, b) => a.ts - b.ts).forEach(x => {
        const tr = tbl.insertRow();
        tr.insertCell().innerText = x.name;
        tr.insertCell().innerText = x.answer;
        tr.insertCell().innerText = formatTime(x.ts, answerStartTime);
      });
    }

    function renderBuzzList() {
      const ol = document.getElementById("buzzList");
      ol.innerHTML = "";
      buzzOrder.forEach(x => {
        const li = document.createElement("li");
        li.innerText = `${x.name} (${formatTime(x.ts, buzzStartTime)})`;
        ol.appendChild(li);
      });
    }

    function updateStatusDisplay() {
      const sA = document.getElementById("statusAnswer");
      const sB = document.getElementById("statusBuzz");
      sA.className = lockedAnswer ? "status-box locked" : "status-box open";
      sA.innerText = lockedAnswer ? "ƒê√°p √°n: üîí ƒêang kh√≥a" : "ƒê√°p √°n: üîì ƒêang m·ªü";

      sB.className = lockedBuzz ? "status-box locked" : "status-box open";
      sB.innerText = lockedBuzz ? "Chu√¥ng: üö´ ƒêang kh√≥a" : "Chu√¥ng: üîî ƒêang m·ªü";
    }

    // TH√äM: H√†m c·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªùi gian tr√¥i qua/c√≤n l·∫°i theo th·ªùi gian th·ª±c
    function updateElapsedDisplay() {
        const now = Date.now();
        const aDisp = document.getElementById("answerTimeElapsed");
        const bDisp = document.getElementById("buzzTimeElapsed");

        // Answer Time
        if (!lockedAnswer && answerDuration_host === 0 && answerStartTime > 0) {
            aDisp.innerHTML = `Th·ªùi gian ƒë√°p √°n ƒë√£ m·ªü: <span style="color:blue;">${format(now - answerStartTime)}</span>`;
        } else if (!lockedAnswer && answerDuration_host > 0 && answerStartTime > 0) {
            const remain = answerStartTime + answerDuration_host * 1000 - now;
            aDisp.innerHTML = `Th·ªùi gian ƒë√°p √°n c√≤n l·∫°i: <span style="color:red;">${format(remain)}</span>`;
        } else {
            aDisp.innerHTML = "";
        }

        // Buzz Time
        if (!lockedBuzz && buzzDuration_host === 0 && buzzStartTime > 0) {
            bDisp.innerHTML = `Th·ªùi gian chu√¥ng ƒë√£ m·ªü: <span style="color:blue;">${format(now - buzzStartTime)}</span>`;
        } else if (!lockedBuzz && buzzDuration_host > 0 && buzzStartTime > 0) {
            const remain = buzzStartTime + buzzDuration_host * 1000 - now;
            bDisp.innerHTML = `Th·ªùi gian chu√¥ng c√≤n l·∫°i: <span style="color:red;">${format(remain)}</span>`;
        } else {
            bDisp.innerHTML = "";
        }
    }


    // ========== T·∫°o ph√≤ng ==========
    document.getElementById("btnCreate").onclick = () => {
      const code = Math.floor(100000 + Math.random() * 900000);
      socket.emit("host-create-room", code);
    };

    socket.on("room-created", code => {
      currentRoom = code;
      document.getElementById("roomInfo").innerHTML =
        `üîë <b>M√£ ph√≤ng:</b> <span style="font-size:1.5em">${code}</span>`;
      answers = [];
      buzzOrder = [];
      renderAnswers();
      renderBuzzList();
      updateStatusDisplay();
      showPopup("T·∫°o ph√≤ng th√†nh c√¥ng!");
      
      // B·∫ÆT ƒê·∫¶U TIMER
      if (hostTimerInterval) clearInterval(hostTimerInterval);
      hostTimerInterval = setInterval(updateElapsedDisplay, 50);
    });

    // ========== Nh·∫≠n d·ªØ li·ªáu ==========
    socket.on("host-new-answer", data => {
      const idx = answers.findIndex(x => x.name === data.name);
      if (idx >= 0) answers[idx] = data;
      else answers.push(data);
      renderAnswers();
    });

    socket.on("host-new-buzz", data => {
      buzzOrder.push(data);
      renderBuzzList();
    });

    // ========== ƒêi·ªÅu khi·ªÉn ƒê√°p √°n ==========
    document.getElementById("unlockAnswersLimited").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc!", "error");
      const duration = Math.max(1, parseInt(answerDuration.value) || 0);
      socket.emit("host-toggle-answer", {
        roomCode: currentRoom,
        state: "open",
        duration
      });
    };

    document.getElementById("unlockAnswersPermanent").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc!", "error");
      socket.emit("host-toggle-answer", {
        roomCode: currentRoom,
        state: "open",
        duration: 0
      });
    };

    document.getElementById("lockAnswers").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc!", "error");
      socket.emit("host-toggle-answer", {
        roomCode: currentRoom,
        state: "locked"
      });
    };

    document.getElementById("resetAnswers").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc!", "error");
      answers = [];
      renderAnswers();
      showPopup("ƒê√£ reset ƒë√°p √°n");
    };

    // ========== ƒêi·ªÅu khi·ªÉn Chu√¥ng ==========
    document.getElementById("unlockBuzzLimited").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc!", "error");
      const duration = Math.max(1, parseInt(buzzDuration.value) || 0);
      socket.emit("host-toggle-buzz", {
        roomCode: currentRoom,
        state: "open",
        duration
      });
    };

    document.getElementById("unlockBuzzPermanent").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc!", "error");
      socket.emit("host-toggle-buzz", { roomCode: currentRoom, state: "open", duration: 0 });
    };

    document.getElementById("lockBuzz").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc!", "error");
      socket.emit("host-toggle-buzz", { roomCode: currentRoom, state: "locked" });
    };

    document.getElementById("resetBuzz").onclick = () => {
      if (!currentRoom) return showPopup("Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc!", "error");
      buzzOrder = [];
      renderBuzzList();
      showPopup("ƒê√£ reset chu√¥ng");
    };

    // ========== ƒê·ªìng b·ªô tr·∫°ng th√°i ==========
    socket.on("answer-status-changed", ({ state, duration, startTime }) => {
      lockedAnswer = state === "locked";
      answerStartTime = state === "open" ? (startTime || 0) : 0;
      answerDuration_host = duration || 0; // L∆∞u duration
      updateStatusDisplay();
      updateElapsedDisplay();
    });

    socket.on("buzz-status-changed", ({ state, duration, startTime }) => {
      lockedBuzz = state === "locked";
      buzzStartTime = state === "open" ? (startTime || 0) : 0;
      buzzDuration_host = duration || 0; // L∆∞u duration
      updateStatusDisplay();
      updateElapsedDisplay();
    });

    updateStatusDisplay();
  </script>

</body>

</html>