<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết Quả</title>
    <style>
        /* ==================== GLOBAL STYLES ==================== */
        body {
            background-color: white; 
            font-family: Arial, sans-serif;
            color: black;
            margin: 0;
            padding: 20px;
            overflow: auto;
            font-weight: bold; 
        }
        
        /* Đảm bảo tất cả các tiêu đề và container con cũng là bold */
        h2, h3, span, p {
            font-weight: bold !important;
            font-style: normal !important;
            color: black !important;
        }

        /* Container thay thế cho khu vực nhập liệu */
        #headerContainer {
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            text-align: center;
        }
        
        #resultsContainer {
            border: 1px solid #ccc;
            padding: 10px;
            background: #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
            min-height: 100px;
        }

        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ff00cc;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        
        /* Đảm bảo chữ đen và đậm cho các dòng kết quả */
        #resultsContainer p {
            color: black !important;
            font-weight: bold !important;
        }
    </style>
</head>
<body>

    <div id="headerContainer">
        <h2 style="margin: 0;">Kết quả</h2>
        <span id="roomStatus" style="color: blue;">Đang kết nối...</span>
    </div>
    
    <div id="resultsContainer">
        <p style="text-align:center; font-weight: bold; font-size: 1em; color: black;">Đang chờ Mã phòng từ URL...</p>
    </div>

    <div id="messageBox"></div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // NOTE: Hãy đảm bảo SOCKET_SERVER_URL khớp với địa chỉ máy chủ của bạn.
        const SOCKET_SERVER_URL = "https://buzzgame1-1.onrender.com"; 
        const socket = io(SOCKET_SERVER_URL, { autoConnect: true });
        
        const resultsContainer = document.getElementById('resultsContainer');
        const messageBox = document.getElementById('messageBox');
        const roomStatus = document.getElementById('roomStatus');
        
        let currentRoom = null; 
        let initialRoomCode = null; // Mã phòng đọc từ URL

        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.style.backgroundColor = isError ? 'red' : 'green'; 
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        // Hàm đọc Mã phòng từ URL (?roomid=123456)
        function getRoomCodeFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const roomid = params.get('roomid');
            // Đảm bảo mã phòng là 6 chữ số
            if (roomid && roomid.length === 6 && !isNaN(roomid)) {
                return parseInt(roomid);
            }
            return null;
        }

        function renderResults(data) {
            resultsContainer.innerHTML = ''; 

            if (data.length === 0) {
                // Đảm bảo chữ đậm và không nghiêng
                resultsContainer.innerHTML = '<p style="text-align:center; font-size: 1em; color: black;">Chưa có đáp án nào được gửi.</p>';
                return;
            }

            data.forEach(item => {
                const totalSeconds = Math.floor(item.time);
                // Lấy 3 chữ số thập phân (milliseconds)
                const milliseconds = Math.round((item.time % 1) * 1000); 
                const formattedTime = `${totalSeconds.toString()}.${milliseconds.toString().padStart(3, '0')}s`;
                
                // Định dạng: Tên người chơi | Đáp án | Thời gian (Toàn bộ là chữ đậm)
                const resultText = `${item.name} | ${item.answer} | ${formattedTime}`;
                
                const p = document.createElement('p');
                // Không cần thẻ <strong> vì CSS global đã là bold
                p.textContent = resultText; 
                p.style.fontSize = '1.2em';
                p.style.borderBottom = '1px dashed #eee'; 
                p.style.padding = '8px 0';
                p.style.margin = '0';
                p.style.textAlign = 'left';
                
                resultsContainer.appendChild(p);
            });
        }
        
        // ========================= SOCKET.IO LOGIC =========================

        // Hàm chung để tham gia phòng
        function joinRoom(roomCode, isRejoin = false) {
            if (!roomCode) {
                 roomStatus.textContent = "LỖI: URL thiếu Mã phòng (roomid=).";
                 resultsContainer.innerHTML = '<p style="text-align:center; font-size: 1em; color: red;">Vui lòng truy cập theo định dạng: **Result.html?roomid=MÃ_PHÒNG**</p>';
                 return;
            }
            
            roomStatus.textContent = `Đang tham gia Phòng: ${roomCode}...`;

            if (isRejoin) {
                socket.emit("viewer-rejoin-room", roomCode);
            } else {
                socket.emit("viewer-join-room", roomCode);
            }
        }
        
        socket.on("connect", () => {
             console.log("Connected to server. ID:", socket.id);
             if (currentRoom) {
                 joinRoom(currentRoom, true);
             } else if (initialRoomCode) {
                 joinRoom(initialRoomCode);
             }
        });

        // Event thành công khi tham gia/rejoin phòng
        socket.on("viewer-join-success", (data) => {
            currentRoom = data.roomCode;
            roomStatus.textContent = `Đang xem kết quả Phòng: ${currentRoom}`;
            renderResults(data.answers);
            showMessage(`Tham gia phòng ${currentRoom} thành công. Cập nhật tự động đã BẬT.`, false);
        });

        // Lắng nghe lỗi khi tham gia
        socket.on("join-error", (message) => {
             roomStatus.textContent = `Lỗi tham gia phòng: ${initialRoomCode}`;
             showMessage(message, true);
             resultsContainer.innerHTML = `<p style="text-align:center; font-size: 1em; color: red;">${message}</p>`;
        });
        
        // Lắng nghe cập nhật kết quả (từ server)
        socket.on("update-results", (data) => {
             renderResults(data);
             console.log("Results updated from server.");
        });

        // Sự kiện khi đáp án bị reset
        socket.on("answers-reset", () => {
            showMessage("Đáp án đã được Host/Manager reset!", true); 
        });

        // Khởi tạo: Đọc mã phòng từ URL và tự động tham gia
        window.onload = () => {
             initialRoomCode = getRoomCodeFromUrl();
             if (socket.connected) {
                 joinRoom(initialRoomCode);
             } 
             // Logic connect sẽ tự xử lý nếu socket chưa kết nối
        };
    </script>
</body>
</html>