<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết Quả</title>
    <style>
        /* CSS Vẫn Giữ Nguyên */
        body {
            background-color: white; 
            font-family: Arial, sans-serif;
            color: black;
            margin: 0;
            padding: 20px;
            overflow: auto;
        }

        #resultsTable {
            width: 100%;
            border-collapse: collapse; 
        }

        /* Thêm header cho bảng kết quả */
        #resultsTable th {
            background-color: #f0f0f0;
            font-size: 1.1em;
            padding: 8px 15px;
            border: 1px solid #aaa;
            text-align: left;
        }

        #resultsTable td {
            font-weight: bold; 
            font-size: 1.2em;
            padding: 8px 15px; 
            border: 1px solid #aaa; /* Thêm border để dễ nhìn */
            text-align: left;
            vertical-align: top;
        }
        
        #resultsTable tr td:nth-child(1) { width: 30%; } 
        #resultsTable tr td:nth-child(2) { width: 45%; } 
        #resultsTable tr td:nth-child(3) { width: 25%; } 

        #inputContainer {
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        #roomCodeInput {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
            font-weight: bold;
        }
        
        /* Thay thế các nút cũ */
        #joinButton {
            padding: 8px 15px;
            font-size: 16px;
            font-weight: bold; 
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s; 
            margin-right: 5px; 
            background-color: green; 
            color: white; 
        }
        
        #joinButton:hover:not(:disabled) {
            background-color: orange;
            color: white;
        }

        #joinButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ff00cc;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="inputContainer">
        <input type="text" id="roomCodeInput" placeholder="Nhập Mã Phòng" value="">
        <button id="joinButton">Tham gia Phòng (Xem Kết Quả)</button>
        <span id="roomStatus" style="margin-left: 20px; color: blue;">Chưa tham gia phòng</span>
    </div>
    
    <table id="resultsTable">
        <thead>
            
        </thead>
        <tbody>
            
        </tbody>
    </table>

    <div id="messageBox"></div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const SOCKET_SERVER_URL = "https://buzzgame1-1.onrender.com"; 
        const socket = io(SOCKET_SERVER_URL, { autoConnect: true });
        
        const resultsTableBody = document.querySelector('#resultsTable tbody');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const joinButton = document.getElementById('joinButton');
        const messageBox = document.getElementById('messageBox');
        const roomStatus = document.getElementById('roomStatus');
        
        let currentRoom = null; 

        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.style.backgroundColor = isError ? 'red' : 'green'; 
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        function renderResults(data) {
            resultsTableBody.innerHTML = ''; 

            if (data.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; font-style:italic; font-weight: normal; font-size: 1em; border: none;">Chưa có đáp án nào được gửi.</td></tr>';
                return;
            }

            // Dữ liệu đã được sắp xếp từ server
            data.forEach(item => {
                const row = resultsTableBody.insertRow();
                
                let cellName = row.insertCell();
                cellName.textContent = item.name;

                let cellAnswer = row.insertCell();
                cellAnswer.textContent = item.answer;
                
                let cellTime = row.insertCell();
                // Định dạng thời gian
                const totalSeconds = Math.floor(item.time);
                const milliseconds = Math.round((item.time % 1) * 1000); 
                cellTime.textContent = `${totalSeconds.toString()}.${milliseconds.toString().padStart(3, '0')}s`;
            });
        }
        
        // ========================= SOCKET.IO LOGIC =========================

        socket.on("connect", () => {
             console.log("Connected to server. ID:", socket.id);
             if (currentRoom) {
                 // Xử lý reconnect: Nếu đã có phòng thì join lại (dùng event mới)
                 socket.emit("viewer-rejoin-room", currentRoom);
             }
        });

        // Event thành công khi tham gia/rejoin phòng
        socket.on("viewer-join-success", (data) => {
            currentRoom = data.roomCode;
            roomStatus.textContent = `Đang xem kết quả Phòng: ${currentRoom}`;
            joinButton.disabled = true;
            roomCodeInput.disabled = true;
            renderResults(data.answers);
            showMessage(`Tham gia phòng ${currentRoom} thành công. Tự động cập nhật đã BẬT.`, false);
        });

        // Lắng nghe lỗi khi tham gia
        socket.on("join-error", (message) => {
             joinButton.disabled = false;
             roomCodeInput.disabled = false;
             showMessage(message, true);
        });
        
        // Lắng nghe cập nhật kết quả (từ server)
        socket.on("update-results", (data) => {
             renderResults(data);
             console.log("Results updated from server.");
        });

        // Sự kiện khi đáp án bị reset (server sẽ gửi update-results rỗng, nhưng dùng event riêng thì rõ ràng hơn)
        socket.on("answers-reset", () => {
            // Tạm thời hiển thị tin nhắn reset, sau đó renderResults rỗng sẽ xóa bảng
            showMessage("Đáp án đã được Host/Manager reset!", true); 
        });

        // Gán sự kiện cho nút Tham gia phòng (Xem Kết Quả)
        joinButton.addEventListener('click', () => {
            const roomCode = roomCodeInput.value.trim();
            if (!roomCode) {
                 showMessage("Vui lòng nhập Mã Phòng.", true);
                 return;
            }
            if (roomCode.length !== 6 || isNaN(roomCode)) {
                 showMessage("Mã phòng phải là 6 chữ số!", true);
                 return;
            }
            
            joinButton.disabled = true;
            roomCodeInput.disabled = true;
            
            // Gửi event lên server để tham gia phòng xem kết quả
            socket.emit("viewer-join-room", parseInt(roomCode));
        });

        window.onload = () => {
             if (roomCodeInput.value.trim()) {
                 // Tự động tham gia nếu đã có mã phòng trong input
                 joinButton.click();
             }
        };
    </script>
</body>
</html>