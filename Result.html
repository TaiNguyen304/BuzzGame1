<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết Quả</title>
    <style>
        /* ==================== GLOBAL STYLES ==================== */
        body {
            background-color: white;
            font-family: Arial, sans-serif;
            color: black;
            margin: 0;
            padding: 20px;
            overflow: auto;
            font-weight: bold;
        }

        h2, h3, span, p {
            font-weight: bold !important;
            font-style: normal !important;
        }

        #headerContainer {
            margin-bottom: 20px;
            padding: 10px;
            background: yellow;
            color: green;
            border-radius: 5px;
            text-align: center;
        }

        #resultsContainer {
            border: 1px solid #ccc;
            padding: 10px;
            background: #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
            min-height: 100px;
        }

        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ff00cc;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        #resultsContainer p {
            color: black !important;
            font-weight: bold !important;
        }

        /* ====== RADIO STYLE ====== */
        .option-group {
            margin: 8px 0;
            font-weight: bold;
            text-align: center;
        }

        .sort-option { color: purple; font-weight: bold; }
        .time-option { color: red; font-weight: bold; }

        .option-group input[type="radio"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #ff00cc;
            margin-right: 6px;
            vertical-align: middle;
            cursor: pointer;
            position: relative;
        }

        .option-group input[type="radio"]:checked {
            border: 2px solid orange;
        }

        .option-group input[type="radio"]:checked::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 8px;
            height: 8px;
            background: blue;
            border-radius: 50%;
        }
    </style>
</head>

<body>

    <div id="headerContainer">
        <h2 style="margin: 0;">Kết quả</h2>
        <span id="roomStatus" style="color: blue;">Đang kết nối...</span>
    </div>

    <div class="option-group sort-option">
        <label>
            <input type="radio" name="sort" value="join" onclick="setSortOption('join')">
            Theo thứ tự vào phòng
        </label>

        <label style="margin-left:20px;">
            <input type="radio" name="sort" value="time" checked onclick="setSortOption('time')">
            Theo thời gian trả lời
        </label>
    </div>

    <div class="option-group time-option">
        <label>
            <input type="radio" name="timeDisplay" value="show" checked onclick="toggleTimeDisplay(true)">
            Hiện thời gian
        </label>

        <label style="margin-left:20px;">
            <input type="radio" name="timeDisplay" value="hide" onclick="toggleTimeDisplay(false)">
            Ẩn thời gian
        </label>
    </div>

    <div id="resultsContainer">
        <p style="text-align:center; font-weight: bold; font-size: 1em; color: blue;">Đang chờ Mã phòng từ URL...</p>
    </div>

    <div id="messageBox"></div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const SOCKET_SERVER_URL = "https://buzzgame1-1.onrender.com";
        const socket = io(SOCKET_SERVER_URL, { autoConnect: true });

        const resultsContainer = document.getElementById('resultsContainer');
        const messageBox = document.getElementById('messageBox');
        const roomStatus = document.getElementById('roomStatus');

        let currentRoom = null;
        let initialRoomCode = null;

        // Cấu hình hiển thị
        let currentSortOption = 'time'; // 'time' hoặc 'join'
        let isShowTime = true;          // true: hiện, false: ẩn
        let allContestants = [];        // Danh sách thí sinh từ Host (thứ tự join)
        let lastResults = [];           // Lưu dữ liệu lần cuối để render lại khi đổi option

        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.style.backgroundColor = isError ? 'red' : 'green';
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        function getRoomCodeFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const roomid = params.get('roomid');
            if (roomid && roomid.length === 6 && !isNaN(roomid)) {
                return parseInt(roomid);
            }
            return null;
        }

        // === HÀM XỬ LÝ SỰ KIỆN RADIO BUTTON ===
        
        // 1. Chuyển đổi cách sắp xếp
        function setSortOption(option) {
            currentSortOption = option;
            // Render lại dữ liệu cũ với cấu hình mới
            if (lastResults.length > 0) {
                renderResults(lastResults);
            }
        }

        // 2. Chuyển đổi hiển thị thời gian
        function toggleTimeDisplay(show) {
            isShowTime = show;
            // Render lại dữ liệu cũ với cấu hình mới
            if (lastResults.length > 0) {
                renderResults(lastResults);
            }
        }

        // === HÀM RENDER CHÍNH ===
        function renderResults(data) {
            // Lưu lại data để dùng khi bấm nút radio
            lastResults = data;
            
            resultsContainer.innerHTML = '';

            if (!data || data.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align:center; font-size: 1em; color: black;">Chưa có đáp án nào được gửi.</p>';
                return;
            }

            // BƯỚC 1: Sao chép mảng để không ảnh hưởng dữ liệu gốc
            const sortedData = [...data];

            // BƯỚC 2: Sắp xếp
            if (currentSortOption === "time") {
                // Sắp xếp theo thời gian trả lời (nhỏ đến lớn)
                sortedData.sort((a, b) => a.time - b.time);
            } else if (currentSortOption === "join") {
                // Sắp xếp theo thứ tự trong mảng allContestants (Host gửi sang)
                sortedData.sort((a, b) => {
                    let idxA = allContestants.indexOf(a.name);
                    let idxB = allContestants.indexOf(b.name);

                    // Nếu tên không có trong danh sách (lỗi/mới vào), đẩy xuống cuối
                    if (idxA === -1) idxA = 9999;
                    if (idxB === -1) idxB = 9999;

                    return idxA - idxB;
                });
            }

            // BƯỚC 3: Hiển thị
            sortedData.forEach(item => {
                // Format thời gian
                const totalSeconds = Math.floor(item.time);
                const milliseconds = Math.round((item.time % 1) * 1000);
                const formattedTime = `${totalSeconds.toString()}.${milliseconds.toString().padStart(3, '0')}s`;

                // Logic hiển thị chuỗi kết quả
                let resultText = "";
                if (isShowTime) {
                    // Hiện thời gian: Tên | Đáp án | Thời gian
                    resultText = `${item.name} | ${item.answer} | ${formattedTime}`;
                } else {
                    // Ẩn thời gian: Tên | Đáp án
                    resultText = `${item.name} | ${item.answer}`;
                }

                const p = document.createElement('p');
                p.textContent = resultText;
                p.style.fontSize = '1.2em';
                p.style.borderBottom = '1px dashed #eee';
                p.style.padding = '8px 0';
                p.style.margin = '0';
                p.style.textAlign = 'left';

                resultsContainer.appendChild(p);
            });
        }

        // ========================= SOCKET.IO LOGIC =========================

        function joinRoom(roomCode, isRejoin = false) {
            if (!roomCode) {
                roomStatus.textContent = "LỖI: URL thiếu Mã phòng (roomid=).";
                resultsContainer.innerHTML = '<p style="text-align:center; font-size: 1em; color: red;">Vui lòng truy cập theo định dạng: **Result.html?roomid=MÃ_PHÒNG**</p>';
                return;
            }

            roomStatus.textContent = `Đang tham gia Phòng: ${roomCode}...`;

            if (isRejoin) {
                socket.emit("viewer-rejoin-room", roomCode);
            } else {
                socket.emit("viewer-join-room", roomCode);
            }
        }

        socket.on("connect", () => {
            console.log("Connected to server. ID:", socket.id);
            if (currentRoom) {
                joinRoom(currentRoom, true);
            } else if (initialRoomCode) {
                joinRoom(initialRoomCode);
            }
        });

        // Event thành công khi tham gia/rejoin phòng
        socket.on("viewer-join-success", (data) => {
            currentRoom = data.roomCode;
            roomStatus.textContent = `Đang xem kết quả Phòng: ${currentRoom}`;
            
            // Cập nhật danh sách thí sinh từ server để phục vụ sort
            if(data.allContestants) {
                allContestants = data.allContestants;
            }

            renderResults(data.answers);
            showMessage(`Tham gia phòng ${currentRoom} thành công.`, false);
        });

        socket.on("join-error", (message) => {
            roomStatus.textContent = `Lỗi tham gia phòng: ${initialRoomCode}`;
            showMessage(message, true);
            resultsContainer.innerHTML = `<p style="text-align:center; font-size: 1em; color: red;">${message}</p>`;
        });

        // Nhận kết quả mới
        socket.on("update-results", (data) => {
            // Cập nhật danh sách thứ tự nếu server có gửi kèm
            if (data.allContestants) {
                allContestants = data.allContestants;
            }
            // Chỉ cập nhật sortOption từ Host nếu cần thiết (hoặc ưu tiên Viewer tự chọn)
            // Ở đây ta ưu tiên lựa chọn của Viewer hiện tại nên không gán đè currentSortOption
            
            renderResults(data.answers);
        });

        // Đồng bộ cấu hình sắp xếp từ Host (cập nhật danh sách thí sinh)
        socket.on("update-sort-config", (data) => {
            if (data.allContestants) {
                allContestants = data.allContestants;
            }
            
            // Nếu có dữ liệu cũ thì render lại ngay để áp dụng thứ tự mới
            if (lastResults.length > 0) {
                renderResults(lastResults);
            }
        });

        socket.on("answers-reset", () => {
            lastResults = [];
            resultsContainer.innerHTML = '<p style="text-align:center; font-size: 1em; color: black;">Host đã reset đáp án.</p>';
            showMessage("Đáp án đã được Host/Manager reset!", true);
        });

        window.onload = () => {
            initialRoomCode = getRoomCodeFromUrl();
            if (socket.connected) {
                joinRoom(initialRoomCode);
            }
        };
    </script>
</body>

</html>